<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pannello Admin - PIZZIAMO?!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">    <script type="module" src="js/firebase-config.js"></script>
    <style>
        /* Loader styles */
        .auth-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex; /* Mostra il loader di default */
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-loader-content { text-align: center; }
        .auth-loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auth-loader-text { color: var(--dark); font-size: 1.2rem; }
        .admin-content { display: none; /* Nascosto finch√© l'auth non √® verificata */ }
    </style>
</head>
<body>    <script type="module">        import { auth, db } from './js/firebase-config.js';
        import { loadPizzas, addPizza, updatePizza, deletePizza, getPizza, categoryMap } from './js/admin-pizze.js';
        import { loadCarouselSlides, addCarouselSlide, updateCarouselSlide, deleteCarouselSlide, getCarouselSlide, updateCarouselOrder } from './js/admin-carousel.js';
        import { loadStoria, saveStoria } from './js/admin-storia.js';
        import { loadValori, addValore, updateValore, deleteValore, getValore, updateValoriOrder } from './js/admin-valori.js';
        import { loadIngredientiSettings, saveIngredientiSettings, loadIngredienti, addIngrediente, updateIngrediente, deleteIngrediente } from './js/admin-ingredienti.js';
        import { loadLocaleSettings, saveLocaleSettings, loadGallery, addGalleryImage, updateGalleryImage, deleteGalleryImage, updateGalleryOrder } from './js/admin-locale.js';
        import { loadTeam, loadTeamSettings, saveTeamSettings, addTeamMember, updateTeamMember, deleteTeamMember } from './js/admin-team.js';
        import { collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // Gestione dell'autenticazione
        auth.onAuthStateChanged(async (user) => {
            const authLoader = document.querySelector('.auth-loader');
            const adminContent = document.querySelector('.admin-content');
            
            if (user) {
                console.log("Utente autenticato:", user.email);
                // Nascondi il loader e mostra il contenuto
                authLoader.style.display = 'none';
                adminContent.style.display = 'block';
                
                // Inizializza il pannello admin
                await initializeAdminPanel();
            } else {
                console.log("Utente non autenticato, reindirizzamento al login");
                window.location.href = 'login.html';
            }
        });

        async function initializeAdminPanel() {
            // Inizializza prima tutte le variabili degli elementi UI
            const successAlert = document.getElementById('successAlert');
            const successMessage = document.getElementById('successMessage');
            const pizzaModal = document.getElementById('pizzaModal');
            const modalBackdrop = document.getElementById('modalBackdrop');
            const deleteModal = document.getElementById('deleteModal');
            const carouselSuccessAlert = document.getElementById('carouselSuccessAlert');
            const carouselSuccessMessage = document.getElementById('carouselSuccessMessage');
            const valoriSuccessAlert = document.getElementById('valoriSuccessAlert');
            const valoriSuccessMessage = document.getElementById('valoriSuccessMessage');
            const ingredientiSuccessAlert = document.getElementById('ingredientiSuccessAlert');
            const ingredientiSuccessMessage = document.getElementById('ingredientiSuccessMessage');
            const localeSuccessAlert = document.getElementById('localeSuccessAlert');
            const localeSuccessMessage = document.getElementById('localeSuccessMessage');
            const storiaSuccessAlert = document.getElementById('storiaSuccessAlert');
            const storiaSuccessMessage = document.getElementById('storiaSuccessMessage');

            // Funzione per mostrare messaggi di successo o errore
            function showSuccessAlert(messageText, alertElement = successAlert, messageElement = successMessage, type = "success") {
                if (!alertElement || !messageElement) {
                    console.error("Elementi di alert non trovati:", alertElement, messageElement);
                    alert(`${type.toUpperCase()}: ${messageText}`);
                    return;
                }
                
                let currentClasses = alertElement.className.split(' ');
                currentClasses = currentClasses.filter(cls => cls !== 'alert-success' && cls !== 'alert-danger');
                
                if (type === "error") {
                    currentClasses.push('alert-danger');
                } else {
                    currentClasses.push('alert-success');
                }
                alertElement.className = currentClasses.join(' ');
                
                messageElement.textContent = messageText;
                alertElement.style.display = 'flex';
                
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 3000);
            }

            // Riferimenti al DOM
            const authLoader = document.getElementById('authLoader');
            const adminContent = document.getElementById('adminContent');

            // Gestione logout
            const logoutButton = document.querySelector('.admin-logout');
            if (logoutButton) {
                logoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    auth.signOut().then(() => {
                        window.location.href = 'login.html';
                    }).catch(error => {
                        console.error('Errore durante il logout:', error);
                        alert('Errore durante il logout: ' + error.message);
                    });
                });
            }
            
            // Toggle Sidebar
            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.querySelector('.admin-sidebar');
            const mainContentEl = document.getElementById('adminMain');
            
            if (toggleBtn && sidebar && mainContentEl) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContentEl.classList.toggle('expanded');
                });
            }
            
            // Navigation menu
            const navLinks = document.querySelectorAll('.admin-menu-link');
            const contentSections = document.querySelectorAll('.content-section');
            
            if (navLinks.length > 0 && contentSections.length > 0) {
                navLinks.forEach(link => {
                    link.addEventListener('click', async function(e) {
                        e.preventDefault();
                        navLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        contentSections.forEach(section => section.style.display = 'none');
                        const targetSectionId = this.getAttribute('data-section');
                        const targetSection = document.getElementById(targetSectionId);
                        if (targetSection) {
                            targetSection.style.display = 'block';
                              // Carica i dati quando si cambia sezione
                            if (targetSectionId === 'carousel-section') {
                                await loadCarouselData();
                            } else if (targetSectionId === 'storia-section') {
                                await loadStoriaData();
                            } else if (targetSectionId === 'valori-section') {
                                await loadValoriData();
                            } else if (targetSectionId === 'ingredienti-section') {
                                await loadIngredientiData();
                            } else if (targetSectionId === 'locale-section') {
                                await loadLocaleData();
                            } else if (targetSectionId === 'team-section') {
                                await loadTeamData();
                            }
                        }
                    });
                });
                if (navLinks[0]) {
                    navLinks[0].click();
                }
            }
            
            // SEZIONE PIZZE (gi√† esistente)
            try {
                const pizze = await loadPizzas();
                loadPizzaTable(pizze);
            } catch (error) {
                console.error("Errore durante il caricamento delle pizze:", error);
                showSuccessAlert("Errore di accesso al database. Verifica la connessione e i permessi.", successAlert, successMessage, "error");
            }

            // Event listener per il form delle pizze
            const pizzaForm = document.getElementById('pizzaForm');
            pizzaForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvataggio in corso...';
                
                try {
                    const ingredientTags = document.querySelectorAll('#pizzaIngredients .tag');
                    const ingredients = Array.from(ingredientTags).map(tag => tag.textContent.trim().replace('√ó', ''));
                    
                    if (ingredients.length === 0) {
                        alert('Aggiungi almeno un ingrediente');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Salva';
                        return;
                    }
                    
                    const pizzaId = document.getElementById('pizzaId').value;
                    const pizzaData = {
                        name: document.getElementById('pizzaName').value,
                        price: parseFloat(document.getElementById('pizzaPrice').value),
                        category: document.getElementById('pizzaCategory').value,
                        description: document.getElementById('pizzaDescription').value,
                        ingredients: ingredients,
                        badge: document.getElementById('pizzaBadge').value,
                        status: parseInt(document.getElementById('pizzaStatus').value),
                        featured: document.getElementById('pizzaFeatured').checked,
                        largeTitle: document.getElementById('pizzaLargeTitle').checked
                    };
                    
                    const fileInput = document.getElementById('pizzaImage');
                    const imageFile = fileInput.files.length > 0 ? fileInput.files[0] : null;
                    
                    if (!imageFile && document.getElementById('previewImage').src && !document.getElementById('previewImage').src.includes('data:image')) {
                        pizzaData.image = document.getElementById('previewImage').src;
                    }
                    
                    if (pizzaId) {
                        await updatePizza(pizzaId, pizzaData, imageFile);
                        showSuccessAlert('Pizza aggiornata con successo!');
                    } else {
                        await addPizza(pizzaData, imageFile);
                        showSuccessAlert('Pizza aggiunta con successo!');
                    }
                    
                    const pizze = await loadPizzas();
                    loadPizzaTable(pizze);
                    
                    document.getElementById('pizzaModal').classList.remove('show');
                    document.getElementById('modalBackdrop').classList.remove('show');
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio della pizza:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva';
                }
            });

            // Event listener per eliminare una pizza
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
                const pizzaId = this.getAttribute('data-id');
                
                try {
                    await deletePizza(pizzaId);
                    const pizze = await loadPizzas();
                    loadPizzaTable(pizze);
                    showSuccessAlert('Pizza eliminata con successo!');
                } catch (error) {
                    console.error("Errore durante l'eliminazione della pizza:", error);
                    alert(`Errore durante l'eliminazione: ${error.message}`);
                }
                
                document.getElementById('deleteModal').classList.remove('show');
                document.getElementById('modalBackdrop').classList.remove('show');
            });
            
            function loadPizzaTable(data) {
                const tableBody = document.getElementById('pizzaTableBody');
                tableBody.innerHTML = '';
                
                data.forEach(pizza => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${pizza.image}" alt="${pizza.name}" class="img-thumbnail"></td>
                        <td>${pizza.name}</td>
                        <td>${categoryMap[pizza.category]}</td>
                        <td>‚Ç¨ ${pizza.price.toFixed(2)}</td>
                        <td>${pizza.status === 1 ? '<span class="badge badge-success">Attiva</span>' : '<span class="badge badge-danger">Disattiva</span>'}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-primary edit-btn" data-id="${pizza.id}">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${pizza.id}" data-name="${pizza.name}">üóëÔ∏è</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                addButtonEventListeners();
            }
            
            function addButtonEventListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const pizzaId = this.getAttribute('data-id');
                        openEditModal(pizzaId);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const pizzaId = this.getAttribute('data-id');
                        const pizzaName = this.getAttribute('data-name');
                        openDeleteModal(pizzaId, pizzaName);
                    });
                });
            }
            
            async function openEditModal(pizzaId) {
                try {
                    const pizza = await getPizza(pizzaId);
                    
                    document.getElementById('pizzaId').value = pizza.id;
                    document.getElementById('pizzaName').value = pizza.name;
                    document.getElementById('pizzaPrice').value = pizza.price;
                    document.getElementById('pizzaCategory').value = pizza.category;
                    document.getElementById('pizzaDescription').value = pizza.description;
                    document.getElementById('pizzaBadge').value = pizza.badge || '';
                    document.getElementById('pizzaStatus').value = pizza.status;
                    document.getElementById('pizzaFeatured').checked = pizza.featured;
                    document.getElementById('pizzaLargeTitle').checked = pizza.largeTitle;
                    
                    const tagsInputContainer = document.getElementById('pizzaIngredients');
                    tagsInputContainer.innerHTML = '<input type="text" placeholder="Aggiungi ingrediente e premi Enter" id="ingredientInput">';
                    const ingredientInputRef = document.getElementById('ingredientInput'); 
                    pizza.ingredients.forEach(ingredient => {
                        addIngredientTag(ingredient); 
                    });
                    
                    const previewImgElement = document.getElementById('previewImage');
                    const imagePreviewContainer = document.getElementById('imagePreview');
                    if (pizza.image) {
                        previewImgElement.src = pizza.image;
                        imagePreviewContainer.style.display = 'flex';
                    } else {
                        previewImgElement.src = '';
                        imagePreviewContainer.style.display = 'none';
                    }
                    
                    document.getElementById('modalTitle').textContent = 'Modifica Pizza';
                    pizzaModal.classList.add('show');
                    modalBackdrop.classList.add('show');
                } catch (error) {
                    console.error("Errore durante il recupero della pizza:", error);
                    alert(`Errore durante il recupero della pizza: ${error.message}`);
                }
            }

            // SEZIONE CAROSELLO
            async function loadCarouselData() {
                try {
                    const slides = await loadCarouselSlides();
                    displayCarouselSlides(slides);
                } catch (error) {
                    console.error("Errore durante il caricamento del carosello:", error);
                    showSuccessAlert("Errore durante il caricamento del carosello", carouselSuccessAlert, carouselSuccessMessage, "error");
                }
            }

            function displayCarouselSlides(slides) {
                const container = document.getElementById('carouselContainer');
                container.innerHTML = '';
                
                slides.forEach((slide, index) => {
                    const slideElement = document.createElement('div');
                    slideElement.className = 'carousel-item';
                    slideElement.setAttribute('data-id', slide.id);
                    slideElement.innerHTML = `
                        <img src="${slide.image}" alt="${slide.alt || 'Slide ' + (index + 1)}">
                        <div class="carousel-item-overlay">
                            <div class="carousel-item-order">${index + 1}</div>
                            <div class="carousel-item-actions">
                                <button class="btn btn-sm btn-secondary edit-carousel-btn" data-id="${slide.id}">üìù</button>
                                <button class="btn btn-sm btn-danger delete-carousel-btn" data-id="${slide.id}">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(slideElement);
                });
                
                setupCarouselEventListeners();
            }

            function setupCarouselEventListeners() {
                document.querySelectorAll('.edit-carousel-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const slideId = this.getAttribute('data-id');
                        try {
                            const slide = await getCarouselSlide(slideId);
                            
                            document.getElementById('carouselItemId').value = slide.id;
                            document.getElementById('carouselAlt').value = slide.alt || '';
                            document.getElementById('carouselPreviewImage').src = slide.image;
                            document.getElementById('carouselImagePreview').style.display = 'flex';
                            
                            document.getElementById('carouselModalTitle').textContent = 'Modifica Immagine Carosello';
                            carouselModal.classList.add('show');
                            modalBackdrop.classList.add('show');
                        } catch (error) {
                            console.error("Errore durante il recupero della slide:", error);
                            alert("Errore durante il recupero della slide");
                        }
                    });
                });

                document.querySelectorAll('.delete-carousel-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
                            const slideId = this.getAttribute('data-id');
                            try {
                                await deleteCarouselSlide(slideId);
                                await loadCarouselData();
                                showSuccessAlert('Immagine eliminata con successo!', carouselSuccessAlert, carouselSuccessMessage);
                            } catch (error) {
                                console.error("Errore durante l'eliminazione:", error);
                                alert("Errore durante l'eliminazione della slide");
                            }
                        }
                    });
                });
            }

            // SEZIONE STORIA
            async function loadStoriaData() {
                try {
                    const storia = await loadStoria();
                    
                    document.getElementById('storiaTitolo').value = storia.titolo || '';
                    document.getElementById('storiaSubtitle').value = storia.sottotitolo || '';
                    document.getElementById('storiaContent').innerHTML = storia.contenuto || '';
                    document.getElementById('storiaAnno').value = storia.anno || '';
                    if (storia.immagine) {
                        document.getElementById('storiaImagePreview').src = storia.immagine;
                    }
                } catch (error) {
                    console.error("Errore durante il caricamento della storia:", error);
                    showSuccessAlert("Errore durante il caricamento della storia", storiaSuccessAlert, storiaSuccessMessage, "error");
                }
            }

            // SEZIONE VALORI
            async function loadValoriData() {
                try {
                    const valori = await loadValori();
                    displayValori(valori);
                } catch (error) {
                    console.error("Errore durante il caricamento dei valori:", error);
                    showSuccessAlert("Errore durante il caricamento dei valori", valoriSuccessAlert, valoriSuccessMessage, "error");
                }
            }

            function displayValori(valori) {
                const container = document.getElementById('valoriContainer');
                container.innerHTML = '';
                
                valori.forEach(valore => {
                    const valoreElement = document.createElement('div');
                    valoreElement.className = 'value-card';
                    valoreElement.setAttribute('data-id', valore.id);
                    valoreElement.innerHTML = `
                        <div class="value-icon">${valore.icon}</div>
                        <h3 class="value-title">${valore.title}</h3>
                        <p class="value-description">${valore.description}</p>
                        <div class="value-actions">
                            <button class="btn btn-sm btn-secondary edit-valore-btn" data-id="${valore.id}">Modifica</button>
                            <button class="btn btn-sm btn-danger delete-valore-btn" data-id="${valore.id}">Elimina</button>
                        </div>
                    `;
                    container.appendChild(valoreElement);
                });
                
                setupValoriEventListeners();
            }

            function setupValoriEventListeners() {
                document.querySelectorAll('.edit-valore-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const valoreId = this.getAttribute('data-id');
                        try {
                            const valore = await getValore(valoreId);
                            
                            document.getElementById('valoreId').value = valore.id;
                            document.getElementById('valoreIcon').value = valore.icon;
                            document.getElementById('valoreTitolo').value = valore.title;
                            document.getElementById('valoreDescrizione').value = valore.description;
                            
                            document.getElementById('valoreModalTitle').textContent = 'Modifica Valore';
                            valoreModal.classList.add('show');
                            modalBackdrop.classList.add('show');
                        } catch (error) {
                            console.error("Errore durante il recupero del valore:", error);
                            alert("Errore durante il recupero del valore");
                        }
                    });
                });

                document.querySelectorAll('.delete-valore-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (confirm('Sei sicuro di voler eliminare questo valore?')) {
                            const valoreId = this.getAttribute('data-id');
                            try {
                                await deleteValore(valoreId);
                                await loadValoriData();
                                showSuccessAlert('Valore eliminato con successo!', valoriSuccessAlert, valoriSuccessMessage);
                            } catch (error) {
                                console.error("Errore durante l'eliminazione:", error);
                                alert("Errore durante l'eliminazione del valore");
                            }
                        }
                    });
                });
            }

            // SEZIONE INGREDIENTI
            async function loadIngredientiData() {
                try {
                    const settings = await loadIngredientiSettings();
                    document.getElementById('ingredientiTitolo').value = settings.titolo || '';
                    document.getElementById('ingredientiIntro').value = settings.introduzione || '';
                    
                    const ingredienti = await loadIngredienti();
                    displayIngredienti(ingredienti);
                } catch (error) {
                    console.error("Errore durante il caricamento degli ingredienti:", error);
                    showSuccessAlert("Errore durante il caricamento degli ingredienti", ingredientiSuccessAlert, ingredientiSuccessMessage, "error");
                }
            }

            function displayIngredienti(ingredienti) {
                const container = document.getElementById('ingredientiContainer');
                container.innerHTML = '';
                
                ingredienti.forEach(ingrediente => {
                    const ingredienteElement = document.createElement('div');
                    ingredienteElement.className = 'ingredient-card';
                    ingredienteElement.setAttribute('data-id', ingrediente.id);
                    ingredienteElement.innerHTML = `
                        <img src="${ingrediente.immagine}" alt="${ingrediente.titolo}" class="ingredient-img">
                        <div class="ingredient-content">
                            <h3 class="ingredient-title">${ingrediente.titolo}</h3>
                            <p class="ingredient-description">${ingrediente.descrizione}</p>
                            <span class="ingredient-badge">${ingrediente.badge}</span>
                            <div class="ingredient-actions">
                                <button class="btn btn-sm btn-secondary edit-ingrediente-btn" data-id="${ingrediente.id}">Modifica</button>
                                <button class="btn btn-sm btn-danger delete-ingrediente-btn" data-id="${ingrediente.id}">Elimina</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(ingredienteElement);
                });
                
                setupIngredientiEventListeners();
            }

            function setupIngredientiEventListeners() {
                document.querySelectorAll('.edit-ingrediente-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const ingredienteId = this.getAttribute('data-id');
                        try {
                            const ingredienti = await loadIngredienti();
                            const ingrediente = ingredienti.find(i => i.id === ingredienteId);
                            
                            if (ingrediente) {
                                document.getElementById('ingredienteId').value = ingrediente.id;
                                document.getElementById('ingredienteTitolo').value = ingrediente.titolo;
                                document.getElementById('ingredienteDescrizione').value = ingrediente.descrizione;
                                document.getElementById('ingredienteBadge').value = ingrediente.badge;
                                
                                if (ingrediente.immagine) {
                                    document.getElementById('ingredientePreviewImage').src = ingrediente.immagine;
                                    document.getElementById('ingredienteImagePreview').style.display = 'flex';
                                }
                                
                                document.getElementById('ingredienteModalTitle').textContent = 'Modifica Ingrediente';
                                ingredienteModal.classList.add('show');
                                modalBackdrop.classList.add('show');
                            }
                        } catch (error) {
                            console.error("Errore durante il recupero dell'ingrediente:", error);
                            alert("Errore durante il recupero dell'ingrediente");
                        }
                    });
                });

                document.querySelectorAll('.delete-ingrediente-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (confirm('Sei sicuro di voler eliminare questo ingrediente?')) {
                            const ingredienteId = this.getAttribute('data-id');
                            try {
                                await deleteIngrediente(ingredienteId);
                                await loadIngredientiData();
                                showSuccessAlert('Ingrediente eliminato con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
                            } catch (error) {
                                console.error("Errore durante l'eliminazione:", error);
                                alert("Errore durante l'eliminazione dell'ingrediente");
                            }
                        }
                    });
                });
            }

            // SEZIONE LOCALE
            async function loadLocaleData() {
                try {
                    const settings = await loadLocaleSettings();
                    document.getElementById('localeTitolo').value = settings.titolo || '';
                    document.getElementById('localeIntro').value = settings.introduzione || '';
                    
                    const gallery = await loadGallery();
                    displayGallery(gallery);
                } catch (error) {
                    console.error("Errore durante il caricamento del locale:", error);
                    showSuccessAlert("Errore durante il caricamento del locale", localeSuccessAlert, localeSuccessMessage, "error");
                }
            }

            function displayGallery(images) {
                const container = document.getElementById('galleryContainer');
                container.innerHTML = '';
                
                images.forEach(image => {
                    const imageElement = document.createElement('div');
                    imageElement.className = 'gallery-item';
                    imageElement.setAttribute('data-id', image.id);
                    imageElement.innerHTML = `
                        <img src="${image.url}" alt="${image.alt}">
                        <div class="gallery-item-overlay">
                            <div class="gallery-item-caption">${image.caption}</div>
                            <div class="gallery-item-actions">
                                <button class="btn btn-sm btn-secondary edit-gallery-btn" data-id="${image.id}">üìù</button>
                                <button class="btn btn-sm btn-danger delete-gallery-btn" data-id="${image.id}">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(imageElement);
                });
                
                setupGalleryEventListeners();
            }

            function setupGalleryEventListeners() {
                document.querySelectorAll('.edit-gallery-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const imageId = this.getAttribute('data-id');
                        try {
                            const gallery = await loadGallery();
                            const image = gallery.find(img => img.id === imageId);
                            
                            if (image) {
                                document.getElementById('galleryItemId').value = image.id;
                                document.getElementById('galleryCaption').value = image.caption;
                                document.getElementById('galleryAlt').value = image.alt;
                                document.getElementById('galleryPreviewImage').src = image.url;
                                document.getElementById('galleryImagePreview').style.display = 'flex';
                                
                                document.getElementById('galleryModalTitle').textContent = 'Modifica Immagine Galleria';
                                galleryModal.classList.add('show');
                                modalBackdrop.classList.add('show');
                            }
                        } catch (error) {
                            console.error("Errore durante il recupero dell'immagine:", error);
                            alert("Errore durante il recupero dell'immagine");
                        }
                    });
                });

                document.querySelectorAll('.delete-gallery-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
                            const imageId = this.getAttribute('data-id');
                            try {
                                await deleteGalleryImage(imageId);
                                await loadLocaleData();
                                showSuccessAlert('Immagine eliminata con successo!', localeSuccessAlert, localeSuccessMessage);
                            } catch (error) {
                                console.error("Errore durante l'eliminazione:", error);
                                alert("Errore durante l'eliminazione dell'immagine");
                            }
                        }
                    });
                });
            }

            // VARIABILI E RIFERIMENTI DOM
            const addPizzaBtn = document.getElementById('addPizzaBtn');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const modalTitle = document.getElementById('modalTitle');

            const closeDeleteModal = document.getElementById('closeDeleteModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const deletePizzaName = document.getElementById('deletePizzaName');

            const carouselModal = document.getElementById('carouselModal');
            const addCarouselBtn = document.getElementById('addCarouselBtn');
            const closeCarouselModal = document.getElementById('closeCarouselModal');
            const cancelCarouselBtn = document.getElementById('cancelCarouselBtn');
            const carouselForm = document.getElementById('carouselForm');

            const valoreModal = document.getElementById('valoreModal');
            const addValoreBtn = document.getElementById('addValoreBtn');
            const closeValoreModal = document.getElementById('closeValoreModal');
            const cancelValoreBtn = document.getElementById('cancelValoreBtn');
            const valoreForm = document.getElementById('valoreForm');

            const ingredienteModal = document.getElementById('ingredienteModal');
            const addIngredienteBtn = document.getElementById('addIngredienteBtn');
            const closeIngredienteModal = document.getElementById('closeIngredienteModal');
            const cancelIngredienteBtn = document.getElementById('cancelIngredienteBtn');
            const ingredienteForm = document.getElementById('ingredienteForm');

            const galleryModal = document.getElementById('galleryModal');
            const addLocaleImageBtn = document.getElementById('addLocaleImageBtn');
            const closeGalleryModal = document.getElementById('closeGalleryModal');
            const cancelGalleryBtn = document.getElementById('cancelGalleryBtn');
            const galleryForm = document.getElementById('galleryForm');

            // Cerca pizze
            document.getElementById('searchPizza').addEventListener('input', async function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const pizze = await loadPizzas();
                const filteredPizze = pizze.filter(pizza => 
                    pizza.name.toLowerCase().includes(searchTerm) || 
                    pizza.description.toLowerCase().includes(searchTerm) ||
                    (pizza.ingredients && pizza.ingredients.some(ing => ing.toLowerCase().includes(searchTerm)))
                );
                loadPizzaTable(filteredPizze);
            });

            // Funzione per aprire il modal di eliminazione
            function openDeleteModal(pizzaId, pizzaNameText) {
                confirmDeleteBtn.setAttribute('data-id', pizzaId);
                deletePizzaName.textContent = pizzaNameText;
                deleteModal.classList.add('show');
                modalBackdrop.classList.add('show');
            }

            // Gestione degli ingredienti come tag
            const ingredientInput = document.getElementById('ingredientInput');
            
            ingredientInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const value = this.value.trim();
                    if (value) {
                        addIngredientTag(value);
                        this.value = '';
                    }
                }
            });
            
            function addIngredientTag(text) {
                const tagsInputContainer = document.getElementById('pizzaIngredients');
                const currentInput = document.getElementById('ingredientInput');
                
                if (!currentInput) {
                    console.error("Input field 'ingredientInput' non trovato dentro 'pizzaIngredients'");
                    return;
                }

                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${text}
                    <span class="tag-remove">√ó</span>
                `;
                
                tag.querySelector('.tag-remove').addEventListener('click', function() {
                    tagsInputContainer.removeChild(tag);
                });
                
                tagsInputContainer.insertBefore(tag, currentInput);
            }

            // Gestione upload immagini
            function handleImageSelection(input, previewId, previewContainerId) {
                if (input.files.length > 0) {
                    const file = input.files[0];
                    
                    if (!file.type.startsWith('image/')) {
                        alert('Per favore seleziona un immagine valida.');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById(previewId).src = e.target.result;
                        document.getElementById(previewContainerId).style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Setup dropzones per tutte le sezioni
            setupDropzone('pizzaImageDropzone', 'pizzaImage', 'previewImage', 'imagePreview');
            setupDropzone('carouselImageDropzone', 'carouselImage', 'carouselPreviewImage', 'carouselImagePreview');
            setupDropzone('storiaImageDropzone', 'storiaImage', 'storiaImagePreview', null);
            setupDropzone('ingredienteImageDropzone', 'ingredienteImage', 'ingredientePreviewImage', 'ingredienteImagePreview');
            setupDropzone('galleryImageDropzone', 'galleryImage', 'galleryPreviewImage', 'galleryImagePreview');

            function setupDropzone(dropzoneId, fileInputId, previewImageId, previewContainerId) {
                const dropzone = document.getElementById(dropzoneId);
                const fileInput = document.getElementById(fileInputId);
                
                if (!dropzone || !fileInput) return;
                
                dropzone.addEventListener('click', function() {
                    fileInput.click();
                });

                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.borderColor = 'var(--primary)';
                    this.style.backgroundColor = 'var(--primary-light)';
                });

                dropzone.addEventListener('dragleave', function() {
                    this.style.borderColor = '#ced4da';
                    this.style.backgroundColor = '';
                });

                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#ced4da';
                    this.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        if (previewContainerId) {
                            handleImageSelection(fileInput, previewImageId, previewContainerId);
                        } else {
                            handleImageSelection(fileInput, previewImageId, previewImageId);
                        }
                    }
                });

                fileInput.addEventListener('change', function() {
                    if (previewContainerId) {
                        handleImageSelection(this, previewImageId, previewContainerId);
                    } else {
                        handleImageSelection(this, previewImageId, previewImageId);
                    }
                });
            }

            // Event listeners per rimuovere immagini
            document.getElementById('removeImage')?.addEventListener('click', function() {
                document.getElementById('pizzaImage').value = '';
                document.getElementById('previewImage').src = '';
                document.getElementById('imagePreview').style.display = 'none';
            });

            document.getElementById('removeCarouselImage')?.addEventListener('click', function() {
                document.getElementById('carouselImage').value = '';
                document.getElementById('carouselImagePreview').style.display = 'none';
            });

            document.getElementById('removeIngredienteImage')?.addEventListener('click', function() {
                document.getElementById('ingredienteImage').value = '';
                document.getElementById('ingredienteImagePreview').style.display = 'none';
            });

            document.getElementById('removeGalleryImage')?.addEventListener('click', function() {
                document.getElementById('galleryImage').value = '';
                document.getElementById('galleryImagePreview').style.display = 'none';
            });

            // Modal handlers
            addPizzaBtn.addEventListener('click', function() {
                pizzaForm.reset();
                document.getElementById('pizzaId').value = '';
                
                const tagsInputContainer = document.getElementById('pizzaIngredients');
                tagsInputContainer.innerHTML = '';
                if (!tagsInputContainer.querySelector('#ingredientInput')) {
                    const newInput = document.createElement('input');
                    newInput.type = 'text';
                    newInput.placeholder = 'Aggiungi ingrediente e premi Enter';
                    newInput.id = 'ingredientInput';
                    tagsInputContainer.appendChild(newInput);
                    newInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const value = this.value.trim();
                            if (value) {
                                addIngredientTag(value);
                                this.value = '';
                            }
                        }
                    });
                }
                
                document.getElementById('previewImage').src = '';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('pizzaImage').value = '';
                
                modalTitle.textContent = 'Aggiungi Pizza';
                pizzaModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });

            closeModal.addEventListener('click', function() {
                pizzaModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            cancelBtn.addEventListener('click', function() {
                pizzaModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            closeDeleteModal.addEventListener('click', function() {
                deleteModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            // Carosello handlers
            addCarouselBtn.addEventListener('click', function() {
                carouselForm.reset();
                document.getElementById('carouselItemId').value = '';
                document.getElementById('carouselImagePreview').style.display = 'none';
                document.getElementById('carouselModalTitle').textContent = 'Aggiungi Immagine Carosello';
                carouselModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });

            closeCarouselModal.addEventListener('click', function() {
                carouselModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            cancelCarouselBtn.addEventListener('click', function() {
                carouselModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            carouselForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('saveCarouselBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvataggio...';
                
                try {
                    const carouselId = document.getElementById('carouselItemId').value;
                    const carouselData = {
                        alt: document.getElementById('carouselAlt').value
                    };
                    
                    const fileInput = document.getElementById('carouselImage');
                    const imageFile = fileInput.files.length > 0 ? fileInput.files[0] : null;
                    
                    if (!imageFile && !carouselId) {
                        alert('Seleziona un\'immagine per il carosello');
                        return;
                    }
                    
                    if (carouselId) {
                        await updateCarouselSlide(carouselId, carouselData, imageFile);
                        showSuccessAlert('Immagine aggiornata con successo!', carouselSuccessAlert, carouselSuccessMessage);
                    } else {
                        await addCarouselSlide(carouselData, imageFile);
                        showSuccessAlert('Immagine aggiunta con successo!', carouselSuccessAlert, carouselSuccessMessage);
                    }
                    
                    await loadCarouselData();
                    carouselModal.classList.remove('show');
                    modalBackdrop.classList.remove('show');
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva';
                }
            });

            document.getElementById('saveOrderBtn').addEventListener('click', async function() {
                const items = document.querySelectorAll('#carouselContainer .carousel-item');
                const order = Array.from(items).map(item => ({
                    id: item.getAttribute('data-id')
                }));
                
                try {
                    await updateCarouselOrder(order);
                    showSuccessAlert('Ordine salvato con successo!', carouselSuccessAlert, carouselSuccessMessage);
                } catch (error) {
                    console.error("Errore durante il salvataggio dell'ordine:", error);
                    alert("Errore durante il salvataggio dell'ordine");
                }
            });

            // Storia handlers
            document.getElementById('saveStoria').addEventListener('click', async function() {
                this.disabled = true;
                this.textContent = 'Salvataggio...';
                
                try {
                    const storiaData = {
                        titolo: document.getElementById('storiaTitolo').value,
                        sottotitolo: document.getElementById('storiaSubtitle').value,
                        contenuto: document.getElementById('storiaContent').innerHTML,
                        anno: document.getElementById('storiaAnno').value
                    };
                    
                    const fileInput = document.getElementById('storiaImage');
                    const imageFile = fileInput.files.length > 0 ? fileInput.files[0] : null;
                    
                    await saveStoria(storiaData, imageFile);
                    showSuccessAlert('Modifiche salvate con successo!', storiaSuccessAlert, storiaSuccessMessage);
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    this.disabled = false;
                    this.textContent = 'Salva Modifiche';
                }
            });

            // WYSIWYG editor
            document.querySelectorAll('.wysiwyg-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const content = document.getElementById('storiaContent');
                    
                    if (this.classList.contains('bold-btn')) {
                        document.execCommand('bold', false, null);
                    } else if (this.classList.contains('italic-btn')) {
                        document.execCommand('italic', false, null);
                    } else if (this.classList.contains('underline-btn')) {
                        document.execCommand('underline', false, null);
                    } else if (this.classList.contains('paragraph-btn')) {
                        document.execCommand('formatBlock', false, '<p>');
                    }
                    
                    content.focus();
                });
            });

            // Valori handlers
            addValoreBtn.addEventListener('click', function() {
                valoreForm.reset();
                document.getElementById('valoreId').value = '';
                document.getElementById('valoreModalTitle').textContent = 'Aggiungi Valore';
                valoreModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });

            closeValoreModal.addEventListener('click', function() {
                valoreModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            cancelValoreBtn.addEventListener('click', function() {
                valoreModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            valoreForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('saveValoreBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvataggio...';
                
                try {
                    const valoreId = document.getElementById('valoreId').value;
                    const valoreData = {
                        icon: document.getElementById('valoreIcon').value,
                        title: document.getElementById('valoreTitolo').value,
                        description: document.getElementById('valoreDescrizione').value
                    };
                    
                    if (valoreId) {
                        await updateValore(valoreId, valoreData);
                        showSuccessAlert('Valore aggiornato con successo!', valoriSuccessAlert, valoriSuccessMessage);
                    } else {
                        await addValore(valoreData);
                        showSuccessAlert('Valore aggiunto con successo!', valoriSuccessAlert, valoriSuccessMessage);
                    }
                    
                    await loadValoriData();
                    valoreModal.classList.remove('show');
                    modalBackdrop.classList.remove('show');
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva';
                }
            });

            document.getElementById('saveValoriOrderBtn').addEventListener('click', async function() {
                const items = document.querySelectorAll('#valoriContainer .value-card');
                const order = Array.from(items).map(item => ({
                    id: item.getAttribute('data-id')
                }));
                
                try {
                    await updateValoriOrder(order);
                    showSuccessAlert('Ordine salvato con successo!', valoriSuccessAlert, valoriSuccessMessage);
                } catch (error) {
                    console.error("Errore durante il salvataggio dell'ordine:", error);
                    alert("Errore durante il salvataggio dell'ordine");
                }
            });

            // Ingredienti handlers
            addIngredienteBtn.addEventListener('click', function() {
                ingredienteForm.reset();
                document.getElementById('ingredienteId').value = '';
                document.getElementById('ingredienteImagePreview').style.display = 'none';
                document.getElementById('ingredienteModalTitle').textContent = 'Aggiungi Ingrediente';
                ingredienteModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });

            closeIngredienteModal.addEventListener('click', function() {
                ingredienteModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            cancelIngredienteBtn.addEventListener('click', function() {
                ingredienteModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            ingredienteForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('saveIngredienteBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvataggio...';
                
                try {
                    const ingredienteId = document.getElementById('ingredienteId').value;
                    const ingredienteData = {
                        titolo: document.getElementById('ingredienteTitolo').value,
                        descrizione: document.getElementById('ingredienteDescrizione').value,
                        badge: document.getElementById('ingredienteBadge').value
                    };
                    
                    const fileInput = document.getElementById('ingredienteImage');
                    const imageFile = fileInput.files.length > 0 ? fileInput.files[0] : null;
                    
                    if (!imageFile && !ingredienteId) {
                        alert('Seleziona un\'immagine per l\'ingrediente');
                        return;
                    }
                    
                    if (ingredienteId) {
                        await updateIngrediente(ingredienteId, ingredienteData, imageFile);
                        showSuccessAlert('Ingrediente aggiornato con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
                    } else {
                        await addIngrediente(ingredienteData, imageFile);
                        showSuccessAlert('Ingrediente aggiunto con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
                    }
                    
                    await loadIngredientiData();
                    ingredienteModal.classList.remove('show');
                    modalBackdrop.classList.remove('show');
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva';
                }
            });

            document.getElementById('saveIngredientiIntroBtn').addEventListener('click', async function() {
                this.disabled = true;
                this.textContent = 'Salvataggio...';
                
                try {
                    const settingsData = {
                        titolo: document.getElementById('ingredientiTitolo').value,
                        introduzione: document.getElementById('ingredientiIntro').value
                    };
                    
                    await saveIngredientiSettings(settingsData);
                    showSuccessAlert('Introduzione salvata con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    this.disabled = false;
                    this.textContent = 'Salva';
                }
            });

            // Locale/Gallery handlers
            addLocaleImageBtn.addEventListener('click', function() {
                galleryForm.reset();
                document.getElementById('galleryItemId').value = '';
                document.getElementById('galleryImagePreview').style.display = 'none';
                document.getElementById('galleryModalTitle').textContent = 'Aggiungi Immagine Galleria';
                galleryModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });

            closeGalleryModal.addEventListener('click', function() {
                galleryModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            cancelGalleryBtn.addEventListener('click', function() {
                galleryModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });

            galleryForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('saveGalleryBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvataggio...';
                
                try {
                    const galleryId = document.getElementById('galleryItemId').value;
                    const galleryData = {
                        caption: document.getElementById('galleryCaption').value,
                        alt: document.getElementById('galleryAlt').value
                    };
                    
                    const fileInput = document.getElementById('galleryImage');
                    const imageFile = fileInput.files.length > 0 ? fileInput.files[0] : null;
                    
                    if (!imageFile && !galleryId) {
                        alert('Seleziona un\'immagine per la galleria');
                        return;
                    }
                    
                    if (galleryId) {
                        await updateGalleryImage(galleryId, galleryData, imageFile);
                        showSuccessAlert('Immagine aggiornata con successo!', localeSuccessAlert, localeSuccessMessage);
                    } else {
                        await addGalleryImage(galleryData, imageFile);
                        showSuccessAlert('Immagine aggiunta con successo!', localeSuccessAlert, localeSuccessMessage);
                    }
                    
                    await loadLocaleData();
                    galleryModal.classList.remove('show');
                    modalBackdrop.classList.remove('show');
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva';
                }
            });

            document.getElementById('saveLocaleIntroBtn').addEventListener('click', async function() {
                this.disabled = true;
                this.textContent = 'Salvataggio...';
                
                try {
                    const settingsData = {
                        titolo: document.getElementById('localeTitolo').value,
                        introduzione: document.getElementById('localeIntro').value
                    };
                    
                    await saveLocaleSettings(settingsData);
                    showSuccessAlert('Introduzione salvata con successo!', localeSuccessAlert, localeSuccessMessage);
                    
                } catch (error) {
                    console.error("Errore durante il salvataggio:", error);
                    alert(`Errore durante il salvataggio: ${error.message}`);
                } finally {
                    this.disabled = false;
                    this.textContent = 'Salva';
                }
            });

            document.getElementById('saveGalleryOrderBtn').addEventListener('click', async function() {
                const items = document.querySelectorAll('#galleryContainer .gallery-item');
                const order = Array.from(items).map(item => ({
                    id: item.getAttribute('data-id')
                }));
                
                try {
                    await updateGalleryOrder(order);
                    showSuccessAlert('Ordine salvato con successo!', localeSuccessAlert, localeSuccessMessage);
                } catch (error) {
                    console.error("Errore durante il salvataggio dell'ordine:", error);
                    alert("Errore durante il salvataggio dell'ordine");
                }
            });            // Chiudi i modal se si clicca fuori
            modalBackdrop.addEventListener('click', function() {
                pizzaModal.classList.remove('show');
                deleteModal.classList.remove('show');
                carouselModal.classList.remove('show');
                valoreModal.classList.remove('show');
                ingredienteModal.classList.remove('show');
                galleryModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
            });
        }
    </script>
    <!-- Auth Loader -->
    <div class="auth-loader" id="authLoader">
        <div class="auth-loader-content">
            <div class="auth-loader-spinner"></div>
            <div class="auth-loader-text">Verifica autenticazione...</div>
        </div>
    </div>
    
    <!-- Wrapper per tutto il contenuto admin -->
    <div class="admin-content" id="adminContent">
        <!-- Header Admin -->
        <header class="admin-header">
            <div class="container admin-header-container">
                <a href="admin.html" class="admin-logo">
                    <img src="img/logopizzeria.png" alt="PIZZIAMO Logo">
                    <h1>Admin Panel</h1>
                </a>
                <div class="admin-actions">
                    <div class="admin-user">
                        <div class="admin-user-avatar">A</div>
                        <span>Admin</span>
                    </div>
                    <a href="index.html" class="admin-logout">Esci</a>
                </div>
            </div>
        </header>
    
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <button class="sidebar-toggle" id="toggleSidebar">‚ò∞</button>
        <ul class="admin-menu">
            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link active" data-section="pizze-section">
                    <span class="admin-menu-icon">üçï</span>
                    <span class="admin-menu-text">Pizze</span>
                </a>
            </li>
            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link" data-section="carousel-section">
                    <span class="admin-menu-icon">üñºÔ∏è</span>
                    <span class="admin-menu-text">Carosello Home</span>
                </a>
            </li>
            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link" data-section="storia-section">
                    <span class="admin-menu-icon">üìñ</span>
                    <span class="admin-menu-text">La Nostra Storia</span>
                </a>
            </li>
            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link" data-section="valori-section">
                    <span class="admin-menu-icon">üå±</span>
                    <span class="admin-menu-text">I Nostri Valori</span>
                </a>
            </li>
            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link" data-section="ingredienti-section">
                    <span class="admin-menu-icon">üçÖ</span>
                    <span class="admin-menu-text">I Nostri Ingredienti</span>
                </a>
            </li>            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link" data-section="locale-section">
                    <span class="admin-menu-icon">üè†</span>
                    <span class="admin-menu-text">Il Nostro Locale</span>
                </a>
            </li>
            <li class="admin-menu-item">
                <a href="#" class="admin-menu-link" data-section="team-section">
                    <span class="admin-menu-icon">üë•</span>
                    <span class="admin-menu-text">Il Nostro Team</span>
                </a>
            </li>
        </ul>
    </aside>
    
    <!-- Main Content -->
    <main class="admin-main" id="adminMain">
        <!-- Sezione Pizze -->
        <section id="pizze-section" class="content-section">
            <div class="page-header">
                <h1 class="page-title">Gestione Pizze</h1>
                <button class="btn btn-primary" id="addPizzaBtn">
                    <span>+</span> Aggiungi Pizza
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="successAlert" style="display: none;">
                <span>‚úì</span>
                <span id="successMessage">Operazione completata con successo!</span>
            </div>
            
            <!-- Pizze Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Elenco Pizze</h2>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Cerca pizza..." id="searchPizza">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="pizzaTable">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Immagine</th>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Prezzo</th>
                                    <th>Stato</th>
                                    <th style="width: 120px;">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="pizzaTableBody">
                                <!-- I dati verranno caricati dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione Carosello -->
        <section id="carousel-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Gestione Carosello Home</h1>
                <button class="btn btn-primary" id="addCarouselBtn">
                    <span>+</span> Aggiungi Immagine
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="carouselSuccessAlert" style="display: none;">
                <span>‚úì</span>
                <span id="carouselSuccessMessage">Operazione completata con successo!</span>
            </div>
            
            <!-- Carosello Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Immagini Carosello</h2>
                    <div>
                        <button class="btn btn-secondary" id="saveOrderBtn">Salva Ordine</button>
                    </div>
                </div>
                <div class="card-body">
                    <p style="margin-bottom: 20px;">Trascina le immagini per riordinare. Le immagini appaiono nel carosello nella homepage del sito.</p>
                    <div class="carousel-manager" id="carouselContainer">
                        <!-- Gli elementi del carosello verranno caricati dinamicamente -->
                        <div class="carousel-item">
                            <img src="img/pizza1.jpg" alt="Slide 1">
                            <div class="carousel-item-overlay">
                                <div class="carousel-item-order">1</div>
                                <div class="carousel-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-carousel-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-carousel-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <img src="img/pizza3.jpg" alt="Slide 2">
                            <div class="carousel-item-overlay">
                                <div class="carousel-item-order">2</div>
                                <div class="carousel-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-carousel-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-carousel-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <img src="img/pizza4.jpg" alt="Slide 3">
                            <div class="carousel-item-overlay">
                                <div class="carousel-item-order">3</div>
                                <div class="carousel-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-carousel-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-carousel-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <img src="img/pizza5.jpg" alt="Slide 4">
                            <div class="carousel-item-overlay">
                                <div class="carousel-item-order">4</div>
                                <div class="carousel-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-carousel-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-carousel-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <img src="img/pizza.jpg" alt="Slide 5">
                            <div class="carousel-item-overlay">
                                <div class="carousel-item-order">5</div>
                                <div class="carousel-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-carousel-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-carousel-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione La Nostra Storia -->
        <section id="storia-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Gestione La Nostra Storia</h1>
                <button class="btn btn-primary" id="saveStoria">
                    <span>üíæ</span> Salva Modifiche
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="storiaSuccessAlert" style="display: none;">
                <span>‚úì</span>
                <span id="storiaSuccessMessage">Modifiche salvate con successo!</span>
            </div>
            
            <!-- Storia Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Come √® iniziato tutto</h2>
                </div>
                <div class="card-body">
                    <div class="storia-editor">
                        <div class="storia-content">
                            <div class="form-group">
                                <label class="form-label">Titolo Sezione</label>
                                <input type="text" class="form-control" id="storiaTitolo" value="La Nostra Storia">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sottotitolo</label>
                                <input type="text" class="form-control" id="storiaSubtitle" value="Come √® iniziato tutto">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contenuto</label>
                                <div class="wysiwyg-toolbar">
                                    <button type="button" class="wysiwyg-btn bold-btn">B</button>
                                    <button type="button" class="wysiwyg-btn italic-btn">I</button>
                                    <button type="button" class="wysiwyg-btn underline-btn">U</button>
                                    <button type="button" class="wysiwyg-btn paragraph-btn">P</button>
                                </div>
                                <div class="wysiwyg-content" id="storiaContent" contenteditable="true">
                                    <p>La storia di PIZZIAMO?! inizia nel 2010, quando il nostro fondatore Marco, dopo anni di esperienza nelle migliori pizzerie italiane, decide di aprire la sua attivit√† a Ferrara con una missione chiara: offrire pizze di altissima qualit√† con ingredienti freschi e a km zero.</p>
                                    <p>Quello che √® iniziato come un piccolo locale con pochi tavoli √® diventato negli anni un punto di riferimento per gli amanti della pizza in citt√†, grazie alla costante ricerca della perfezione e all'amore per la tradizione culinaria italiana.</p>
                                    <p>Nel corso degli anni abbiamo ampliato il locale, migliorato continuamente le nostre ricette e creato un team di professionisti appassionati che condividono la nostra filosofia: la pizza non √® solo cibo, √® un'esperienza.</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anno (badge)</label>
                                <input type="text" class="form-control" id="storiaAnno" value="2010">
                            </div>
                        </div>
                        <div class="storia-image-preview">
                            <div class="form-group">
                                <label class="form-label">Immagine</label>
                                <div class="dropzone" id="storiaImageDropzone">
                                    <div class="dropzone-content">
                                        <div class="dropzone-icon">üìÅ</div>
                                        <div class="dropzone-text">Trascina un'immagine qui o clicca per selezionare</div>
                                    </div>
                                    <input type="file" id="storiaImage" style="display: none;" accept="image/*">
                                </div>
                            </div>
                            <div class="preview-container" style="margin-top: 20px;">
                                <img src="img/pizza1.jpg" alt="Storia Preview" id="storiaImagePreview">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione I Nostri Valori -->
        <section id="valori-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Gestione I Nostri Valori</h1>
                <button class="btn btn-primary" id="addValoreBtn">
                    <span>+</span> Aggiungi Valore
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="valoriSuccessAlert" style="display: none;">
                <span>‚úì</span>
                <span id="valoriSuccessMessage">Operazione completata con successo!</span>
            </div>
            
            <!-- Valori Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Elenco Valori</h2>
                    <button class="btn btn-secondary" id="saveValoriOrderBtn">Salva Ordine</button>
                </div>
                <div class="card-body">
                    <div class="values-grid" id="valoriContainer">
                        <!-- I valori verranno caricati dinamicamente -->
                        <div class="value-card">
                            <div class="value-icon">üå±</div>
                            <h3 class="value-title">Qualit√† e Freschezza</h3>
                            <p class="value-description">Utilizziamo solo ingredienti freschi e di alta qualit√†, selezionati con cura dai migliori produttori locali. Ogni pizza che serviamo riflette il nostro impegno per l'eccellenza.</p>
                            <div class="value-actions">
                                <button class="btn btn-sm btn-secondary edit-valore-btn">Modifica</button>
                                <button class="btn btn-sm btn-danger delete-valore-btn">Elimina</button>
                            </div>
                        </div>
                        <div class="value-card">
                            <div class="value-icon">üåç</div>
                            <h3 class="value-title">Sostenibilit√†</h3>
                            <p class="value-description">Ci impegniamo a ridurre il nostro impatto ambientale utilizzando materiali compostabili per il delivery, riducendo gli sprechi e sostenendo l'agricoltura locale.</p>
                            <div class="value-actions">
                                <button class="btn btn-sm btn-secondary edit-valore-btn">Modifica</button>
                                <button class="btn btn-sm btn-danger delete-valore-btn">Elimina</button>
                            </div>
                        </div>
                        <div class="value-card">
                            <div class="value-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <h3 class="value-title">Comunit√†</h3>
                            <p class="value-description">Crediamo nell'importanza di costruire relazioni forti con la nostra comunit√†. Supportiamo eventi locali e collaboriamo con altre attivit√† del territorio.</p>
                            <div class="value-actions">
                                <button class="btn btn-sm btn-secondary edit-valore-btn">Modifica</button>
                                <button class="btn btn-sm btn-danger delete-valore-btn">Elimina</button>
                            </div>
                        </div>
                        <div class="value-card">
                            <div class="value-icon">üîÑ</div>
                            <h3 class="value-title">Innovazione nella Tradizione</h3>
                            <p class="value-description">Rispettiamo la tradizione pizzaiola italiana mentre cerchiamo costantemente modi innovativi per migliorare le nostre ricette e i nostri processi.</p>
                            <div class="value-actions">
                                <button class="btn btn-sm btn-secondary edit-valore-btn">Modifica</button>
                                <button class="btn btn-sm btn-danger delete-valore-btn">Elimina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione I Nostri Ingredienti -->
        <section id="ingredienti-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Gestione I Nostri Ingredienti</h1>
                <button class="btn btn-primary" id="addIngredienteBtn">
                    <span>+</span> Aggiungi Ingrediente
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="ingredientiSuccessAlert" style="display: none;">
                <span>‚úì</span>
                <span id="ingredientiSuccessMessage">Operazione completata con successo!</span>
            </div>
            
            <!-- Introduzione Ingredienti -->
            <div class="card" style="margin-bottom: 30px;">
                <div class="card-header">
                    <h2 class="card-title">Testo Introduttivo</h2>
                    <button class="btn btn-secondary" id="saveIngredientiIntroBtn">Salva</button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Titolo Sezione</label>
                        <input type="text" class="form-control" id="ingredientiTitolo" value="I Nostri Ingredienti">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Introduzione</label>
                        <textarea class="form-control" id="ingredientiIntro" rows="3">La qualit√† dei nostri ingredienti √® il segreto del nostro successo. Collaboriamo con produttori locali che condividono la nostra passione per il cibo eccellente e sostenibile. Ogni ingrediente √® selezionato con cura per garantire pizze dal sapore autentico e inconfondibile.</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Ingredienti Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Elenco Ingredienti</h2>
                </div>
                <div class="card-body">
                    <div class="ingredients-grid" id="ingredientiContainer">
                        <!-- Gli ingredienti verranno caricati dinamicamente -->
                        <div class="ingredient-card">
                            <img src="img/pizza1.jpg" alt="Pomodori San Marzano" class="ingredient-img">
                            <div class="ingredient-content">
                                <h3 class="ingredient-title">Pomodori San Marzano DOP</h3>
                                <p class="ingredient-description">Coltivati nelle fertile terre campane, i nostri pomodori San Marzano sono dolci, poco acidi e con pochi semi.</p>
                                <span class="ingredient-badge">Campania</span>
                                <div class="ingredient-actions">
                                    <button class="btn btn-sm btn-secondary edit-ingrediente-btn">Modifica</button>
                                    <button class="btn btn-sm btn-danger delete-ingrediente-btn">Elimina</button>
                                </div>
                            </div>
                        </div>
                        <div class="ingredient-card">
                            <img src="img/pizza2.jpg" alt="Mozzarella di Bufala" class="ingredient-img">
                            <div class="ingredient-content">
                                <h3 class="ingredient-title">Mozzarella di Bufala</h3>
                                <p class="ingredient-description">Fresca e filante, la nostra mozzarella di bufala campana DOP √® consegnata settimanalmente per garantire massima freschezza.</p>
                                <span class="ingredient-badge">DOP</span>
                                <div class="ingredient-actions">
                                    <button class="btn btn-sm btn-secondary edit-ingrediente-btn">Modifica</button>
                                    <button class="btn btn-sm btn-danger delete-ingrediente-btn">Elimina</button>
                                </div>
                            </div>
                        </div>
                        <div class="ingredient-card">
                            <img src="img/pizza3.jpg" alt="Farina per l'impasto" class="ingredient-img">
                            <div class="ingredient-content">
                                <h3 class="ingredient-title">Farina Speciale</h3>
                                <p class="ingredient-description">Il nostro impasto speciale √® creato con un mix di farine selezionate che garantiscono leggerezza e digeribilit√†.</p>
                                <span class="ingredient-badge">Esclusiva</span>
                                <div class="ingredient-actions">
                                    <button class="btn btn-sm btn-secondary edit-ingrediente-btn">Modifica</button>
                                    <button class="btn btn-sm btn-danger delete-ingrediente-btn">Elimina</button>
                                </div>
                            </div>
                        </div>
                        <div class="ingredient-card">
                            <img src="img/pizza4.jpg" alt="Olio Extra Vergine" class="ingredient-img">
                            <div class="ingredient-content">
                                <h3 class="ingredient-title">Olio Extra Vergine d'Oliva</h3>
                                <p class="ingredient-description">Il nostro olio EVO √® spremuto a freddo da olive italiane, conferendo alle pizze un aroma unico e inconfondibile.</p>
                                <span class="ingredient-badge">Bio</span>
                                <div class="ingredient-actions">
                                    <button class="btn btn-sm btn-secondary edit-ingrediente-btn">Modifica</button>
                                    <button class="btn btn-sm btn-danger delete-ingrediente-btn">Elimina</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Sezione Il Nostro Locale -->
        <section id="locale-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Gestione Il Nostro Locale</h1>
                <button class="btn btn-primary" id="addLocaleImageBtn">
                    <span>+</span> Aggiungi Immagine
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="localeSuccessAlert" style="display: none;">
                <span>‚úì</span>
                <span id="localeSuccessMessage">Operazione completata con successo!</span>
            </div>
            
            <!-- Introduzione Locale -->
            <div class="card" style="margin-bottom: 30px;">
                <div class="card-header">
                    <h2 class="card-title">Testo Introduttivo</h2>
                    <button class="btn btn-secondary" id="saveLocaleIntroBtn">Salva</button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Titolo Sezione</label>
                        <input type="text" class="form-control" id="localeTitolo" value="Il Nostro Locale">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Introduzione</label>
                        <textarea class="form-control" id="localeIntro" rows="3">Il nostro locale √® stato progettato per offrirti un ambiente accogliente dove gustare le nostre specialit√†. Un mix di design moderno e atmosfera familiare che ti far√† sentire subito a tuo agio.</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Galleria Locale -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Galleria Foto</h2>
                    <button class="btn btn-secondary" id="saveGalleryOrderBtn">Salva Ordine</button>
                </div>
                <div class="card-body">
                    <div class="gallery-manager" id="galleryContainer">
                        <!-- Le immagini verranno caricate dinamicamente -->
                        <div class="gallery-item">
                            <img src="img/pizza5.jpg" alt="Esterno del locale">
                            <div class="gallery-item-overlay">
                                <div class="gallery-item-caption">L'esterno del nostro locale</div>
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-gallery-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-gallery-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <img src="img/pizza.jpg" alt="Area principale">
                            <div class="gallery-item-overlay">
                                <div class="gallery-item-caption">La sala principale</div>
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-gallery-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-gallery-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <img src="img/pizzaiolo1.jpg" alt="Forno a legna">
                            <div class="gallery-item-overlay">
                                <div class="gallery-item-caption">Il nostro forno a legna</div>
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-gallery-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-gallery-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-item">
                            <img src="img/pizzaiolo2.jpg" alt="Dettaglio tavolo">
                            <div class="gallery-item-overlay">
                                <div class="gallery-item-caption">I nostri tavoli</div>
                                <div class="gallery-item-actions">
                                    <button class="btn btn-sm btn-secondary edit-gallery-btn">üìù</button>
                                    <button class="btn btn-sm btn-danger delete-gallery-btn">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>        </section>
        
        <!-- Sezione Il Nostro Team -->
        <section id="team-section" class="content-section" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">Gestione Il Nostro Team</h1>
                <button class="btn btn-primary" id="addTeamMemberBtn">
                    <span>+</span> Aggiungi Membro
                </button>
            </div>
            
            <!-- Alert Success -->
            <div class="alert alert-success" id="teamSuccessAlert" style="display: none;">
                <span>‚úì</span>
                <span id="teamSuccessMessage">Operazione completata con successo!</span>
            </div>
            
            <!-- Impostazioni Team -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Impostazioni Sezione</h2>
                    <button class="btn btn-secondary" id="saveTeamSettingsBtn">Salva Impostazioni</button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Titolo Sezione</label>
                        <input type="text" class="form-control" id="teamTitolo" value="Il Nostro Team">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Introduzione</label>
                        <textarea class="form-control" id="teamIntro" rows="3">Dietro ogni pizza perfetta c'√® una squadra appassionata e dedicata. Conosciamo le persone che ogni giorno lavorano con passione per offrirti l'esperienza PIZZIAMO?!</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Team Members -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Membri del Team</h2>
                </div>
                <div class="card-body">
                    <div class="team-grid" id="teamContainer">
                        <!-- I membri del team verranno caricati dinamicamente -->
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Add/Edit Pizza Modal -->
    <div class="modal" id="pizzaModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Aggiungi Pizza</h3>
                    <button type="button" class="modal-close" id="closeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="pizzaForm">
                        <input type="hidden" id="pizzaId">
                        
                        <div class="form-group">
                            <label for="pizzaName" class="form-label">Nome Pizza*</label>
                            <input type="text" class="form-control" id="pizzaName" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col-6">
                                <div class="form-group">
                                    <label for="pizzaPrice" class="form-label">Prezzo (‚Ç¨)*</label>
                                    <input type="number" class="form-control" id="pizzaPrice" min="0" step="0.50" required>
                                </div>
                            </div>
                            <div class="form-col-6">
                                <div class="form-group">
                                    <label for="pizzaCategory" class="form-label">Categoria*</label>
                                    <select class="form-select" id="pizzaCategory" required>
                                        <option value="">Seleziona categoria</option>
                                        <option value="classiche">Classiche</option>
                                        <option value="speciali">Specialit√†</option>
                                        <option value="limited">Limited Edition</option>
                                        <option value="vegane">Vegane</option>
                                        <option value="senza-glutine">Senza Glutine</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="pizzaDescription" class="form-label">Descrizione*</label>
                            <textarea class="form-control" id="pizzaDescription" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ingredienti*</label>
                            <div class="tags-input" id="pizzaIngredients">
                                <input type="text" placeholder="Aggiungi ingrediente e premi Enter" id="ingredientInput">
                            </div>
                            <small class="form-text">Premi Enter dopo ogni ingrediente per aggiungerlo alla lista</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Immagine*</label>
                            <div class="dropzone" id="pizzaImageDropzone">
                                <div class="dropzone-content">
                                    <div class="dropzone-icon">üìÅ</div>
                                    <div class="dropzone-text">Trascina un'immagine qui o clicca per selezionare</div>
                                </div>
                                <input type="file" id="pizzaImage" style="display: none;" accept="image/*">
                            </div>
                            <div class="preview-container" id="imagePreview" style="display: none;">
                                <img src="" alt="Preview" class="preview-image" id="previewImage">
                                <button type="button" class="btn btn-sm btn-danger" id="removeImage">Rimuovi</button>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col-6">
                                <div class="form-group">
                                    <label for="pizzaBadge" class="form-label">Badge (opzionale)</label>
                                    <input type="text" class="form-control" id="pizzaBadge" placeholder="es. Novit√†, Consigliata">
                                </div>
                            </div>
                            <div class="form-col-6">
                                <div class="form-group">
                                    <label for="pizzaStatus" class="form-label">Stato</label>
                                    <select class="form-select" id="pizzaStatus">
                                        <option value="1">Attiva</option>
                                        <option value="0">Disattiva</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="pizzaFeatured">
                                <label class="form-check-label" for="pizzaFeatured">In evidenza</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="pizzaLargeTitle">
                                <label class="form-check-label" for="pizzaLargeTitle">Usa titolo grande</label>
                            </div>
                            <small class="form-text">Attiva questa opzione per le pizze speciali con il nome sovraimpresso all'immagine.</small>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" id="cancelBtn">Annulla</button>
                            <button type="submit" class="btn btn-primary" id="saveBtn">Salva</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Conferma eliminazione</h3>
                    <button type="button" class="modal-close" id="closeDeleteModal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Sei sicuro di voler eliminare la pizza <strong id="deletePizzaName"></strong>?</p>
                    <p>Questa operazione non pu√≤ essere annullata.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Annulla</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Elimina</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carousel Image Modal -->
    <div class="modal" id="carouselModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="carouselModalTitle">Aggiungi Immagine Carosello</h3>
                    <button type="button" class="modal-close" id="closeCarouselModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="carouselForm">
                        <input type="hidden" id="carouselItemId">
                        
                        <div class="form-group">
                            <label for="carouselAlt" class="form-label">Titolo/Descrizione*</label>
                            <input type="text" class="form-control" id="carouselAlt" required>
                            <small class="form-text">Questo testo verr√† mostrato quando l'immagine non pu√≤ essere caricata e aiuta l'accessibilit√†.</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Immagine*</label>
                            <div class="dropzone" id="carouselImageDropzone">
                                <div class="dropzone-content">
                                    <div class="dropzone-icon">üìÅ</div>
                                    <div class="dropzone-text">Trascina un'immagine qui o clicca per selezionare</div>
                                </div>
                                <input type="file" id="carouselImage" style="display: none;" accept="image/*">
                            </div>
                            <div class="preview-container" id="carouselImagePreview" style="display: none;">
                                <img src="" alt="Preview" class="preview-image" id="carouselPreviewImage">
                                <button type="button" class="btn btn-sm btn-danger" id="removeCarouselImage">Rimuovi</button>
                            </div>
                            <small class="form-text">Dimensione consigliata: 1200x450 pixel</small>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" id="cancelCarouselBtn">Annulla</button>
                            <button type="submit" class="btn btn-primary" id="saveCarouselBtn">Salva</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Valore Modal -->
    <div class="modal" id="valoreModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="valoreModalTitle">Aggiungi Valore</h3>
                    <button type="button" class="modal-close" id="closeValoreModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="valoreForm">
                        <input type="hidden" id="valoreId">
                        
                        <div class="form-group">
                            <label for="valoreIcon" class="form-label">Icona*</label>
                            <input type="text" class="form-control" id="valoreIcon" required placeholder="Es: üå±, üåç, üë®‚Äçüë©‚Äçüëß‚Äçüë¶, üîÑ">
                            <small class="form-text">Inserisci un'emoji come icona del valore</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="valoreTitolo" class="form-label">Titolo*</label>
                            <input type="text" class="form-control" id="valoreTitolo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="valoreDescrizione" class="form-label">Descrizione*</label>
                            <textarea class="form-control" id="valoreDescrizione" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" id="cancelValoreBtn">Annulla</button>
                            <button type="submit" class="btn btn-primary" id="saveValoreBtn">Salva</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ingrediente Modal -->
    <div class="modal" id="ingredienteModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="ingredienteModalTitle">Aggiungi Ingrediente</h3>
                    <button type="button" class="modal-close" id="closeIngredienteModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="ingredienteForm">
                        <input type="hidden" id="ingredienteId">
                        
                        <div class="form-group">
                            <label for="ingredienteTitolo" class="form-label">Nome Ingrediente*</label>
                            <input type="text" class="form-control" id="ingredienteTitolo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="ingredienteDescrizione" class="form-label">Descrizione*</label>
                            <textarea class="form-control" id="ingredienteDescrizione" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="ingredienteBadge" class="form-label">Badge (origine, certificazione)*</label>
                            <input type="text" class="form-control" id="ingredienteBadge" required placeholder="Es: DOP, Bio, Campania">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Immagine*</label>
                            <div class="dropzone" id="ingredienteImageDropzone">
                                <div class="dropzone-content">
                                    <div class="dropzone-icon">üìÅ</div>
                                    <div class="dropzone-text">Trascina un'immagine qui o clicca per selezionare</div>
                                </div>
                                <input type="file" id="ingredienteImage" style="display: none;" accept="image/*">
                            </div>
                            <div class="preview-container" id="ingredienteImagePreview" style="display: none;">
                                <img src="" alt="Preview" class="preview-image" id="ingredientePreviewImage">
                                <button type="button" class="btn btn-sm btn-danger" id="removeIngredienteImage">Rimuovi</button>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" id="cancelIngredienteBtn">Annulla</button>
                            <button type="submit" class="btn btn-primary" id="saveIngredienteBtn">Salva</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gallery Image Modal -->
    <div class="modal" id="galleryModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="galleryModalTitle">Aggiungi Immagine Galleria</h3>
                    <button type="button" class="modal-close" id="closeGalleryModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="galleryForm">
                        <input type="hidden" id="galleryItemId">
                        
                        <div class="form-group">
                            <label for="galleryCaption" class="form-label">Didascalia*</label>
                            <input type="text" class="form-control" id="galleryCaption" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="galleryAlt" class="form-label">Testo alternativo*</label>
                            <input type="text" class="form-control" id="galleryAlt" required>
                            <small class="form-text">Questo testo viene utilizzato per l'accessibilit√†</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Immagine*</label>
                            <div class="dropzone" id="galleryImageDropzone">
                                <div class="dropzone-content">
                                    <div class="dropzone-icon">üìÅ</div>
                                    <div class="dropzone-text">Trascina un'immagine qui o clicca per selezionare</div>
                                </div>
                                <input type="file" id="galleryImage" style="display: none;" accept="image/*">
                            </div>
                            <div class="preview-container" id="galleryImagePreview" style="display: none;">
                                <img src="" alt="Preview" class="preview-image" id="galleryPreviewImage">
                                <button type="button" class="btn btn-sm btn-danger" id="removeGalleryImage">Rimuovi</button>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" id="cancelGalleryBtn">Annulla</button>
                            <button type="submit" class="btn btn-primary" id="saveGalleryBtn">Salva</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>    </div>
    
    <!-- Team Member Modal -->
    <div class="modal" id="teamModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="teamModalTitle">Aggiungi Membro del Team</h3>
                    <button type="button" class="modal-close" id="closeTeamModal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="teamForm">
                        <input type="hidden" id="teamMemberId">
                        
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="teamNome" class="form-label">Nome*</label>
                                    <input type="text" class="form-control" id="teamNome" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="teamRuolo" class="form-label">Ruolo*</label>
                                    <input type="text" class="form-control" id="teamRuolo" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="teamDescrizione" class="form-label">Descrizione*</label>
                            <textarea class="form-control" id="teamDescrizione" rows="3" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="teamOrdine" class="form-label">Ordine visualizzazione*</label>
                                    <input type="number" class="form-control" id="teamOrdine" min="1" required>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="teamStatus" class="form-label">Stato*</label>
                                    <select class="form-select" id="teamStatus" required>
                                        <option value="1">Attivo</option>
                                        <option value="0">Nascosto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Social Media (opzionale)</label>
                            <div class="row">
                                <div class="col">
                                    <input type="url" class="form-control" id="teamFacebook" placeholder="Link Facebook">
                                </div>
                                <div class="col">
                                    <input type="url" class="form-control" id="teamInstagram" placeholder="Link Instagram">
                                </div>
                                <div class="col">
                                    <input type="url" class="form-control" id="teamTwitter" placeholder="Link Twitter">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Foto*</label>
                            <div class="dropzone" id="teamImageDropzone">
                                <div class="dropzone-content">
                                    <div class="dropzone-icon">üìÅ</div>
                                    <div class="dropzone-text">Trascina una foto qui o clicca per selezionare</div>
                                </div>
                                <input type="file" id="teamImage" style="display: none;" accept="image/*">
                            </div>
                            <div class="preview-container" id="teamImagePreview" style="display: none;">
                                <img src="" alt="Preview" class="preview-image" id="teamPreviewImage">
                                <button type="button" class="btn btn-sm btn-danger" id="removeTeamImage">Rimuovi</button>
                            </div>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" id="cancelTeamBtn">Annulla</button>
                            <button type="submit" class="btn btn-primary" id="saveTeamBtn">Salva</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modalBackdrop"></div>
    </div> <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { loadPizzas, addPizza, updatePizza, deletePizza, getPizza, categoryMap } from './js/admin-pizze.js';
    import { collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

    document.addEventListener('DOMContentLoaded', async function() {
        // Inizializza prima tutte le variabili degli elementi UI
        const successAlert = document.getElementById('successAlert');
        const successMessage = document.getElementById('successMessage');
        const pizzaModal = document.getElementById('pizzaModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const deleteModal = document.getElementById('deleteModal');
        const carouselSuccessAlert = document.getElementById('carouselSuccessAlert');
        const carouselSuccessMessage = document.getElementById('carouselSuccessMessage');
        const valoriSuccessAlert = document.getElementById('valoriSuccessAlert');
        const valoriSuccessMessage = document.getElementById('valoriSuccessMessage');
        const ingredientiSuccessAlert = document.getElementById('ingredientiSuccessAlert');
        const ingredientiSuccessMessage = document.getElementById('ingredientiSuccessMessage');
        const localeSuccessAlert = document.getElementById('localeSuccessAlert');
        const localeSuccessMessage = document.getElementById('localeSuccessMessage');
        const storiaSuccessAlert = document.getElementById('storiaSuccessAlert');
        const storiaSuccessMessage = document.getElementById('storiaSuccessMessage');

        // Funzione per mostrare messaggi di successo o errore
        function showSuccessAlert(messageText, alertElement = successAlert, messageElement = successMessage, type = "success") {
            if (!alertElement || !messageElement) {
                console.error("Elementi di alert non trovati:", alertElement, messageElement);
                // Fallback to a simple alert if UI elements are missing
                alert(`${type.toUpperCase()}: ${messageText}`);
                return;
            }
            
            // Ensure class manipulation is safe
            let currentClasses = alertElement.className.split(' ');
            currentClasses = currentClasses.filter(cls => cls !== 'alert-success' && cls !== 'alert-danger');
            
            if (type === "error") {
                currentClasses.push('alert-danger');
            } else {
                currentClasses.push('alert-success');
            }
            alertElement.className = currentClasses.join(' ');
            
            messageElement.textContent = messageText;
            alertElement.style.display = 'flex';
            
            // Nascondi dopo 3 secondi
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 3000);
        }

        // Riferimenti al DOM che potrebbero essere gi√† stati gestiti da protectAdminPages
        // per la visualizzazione iniziale, ma utili qui per altre interazioni.
        const authLoader = document.getElementById('authLoader');
        const adminContent = document.getElementById('adminContent');

        // Gestione logout
        const logoutButton = document.querySelector('.admin-logout');
        if (logoutButton) {
            logoutButton.addEventListener('click', function(e) {
                e.preventDefault();
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch(error => {
                    console.error('Errore durante il logout:', error);
                    alert('Errore durante il logout: ' + error.message); // Feedback utente
                });
            });
        }
        
        // Toggle Sidebar
        const toggleBtn = document.getElementById('toggleSidebar');
        const sidebar = document.querySelector('.admin-sidebar');
        const mainContentEl = document.getElementById('adminMain'); // Rinominato per evitare conflitto con variabile adminContent
        
        if (toggleBtn && sidebar && mainContentEl) {
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                mainContentEl.classList.toggle('expanded');
            });
        }
        
        // Navigation menu
        const navLinks = document.querySelectorAll('.admin-menu-link');
        const contentSections = document.querySelectorAll('.content-section');
        
        if (navLinks.length > 0 && contentSections.length > 0) {
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    contentSections.forEach(section => section.style.display = 'none');
                    const targetSectionId = this.getAttribute('data-section');
                    const targetSection = document.getElementById(targetSectionId);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    } else {
                        console.warn('Sezione non trovata:', targetSectionId);
                    }
                });
            });
            // Attiva la prima sezione di default se esiste
            if (navLinks[0]) {
                navLinks[0].click();
            }
        }
        
        // Carica le pizze quando la pagina si carica
        try {
            const pizze = await loadPizzas();
            loadPizzaTable(pizze);
        } catch (error) {
            console.error("Errore durante il caricamento delle pizze:", error);
            showSuccessAlert("Errore di accesso al database. Verifica la connessione e i permessi.", successAlert, successMessage, "error");
        }

        // Event listener per il form delle pizze
        const pizzaForm = document.getElementById('pizzaForm');
        pizzaForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disabilita il pulsante di invio durante l'operazione
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvataggio in corso...';
            
            try {
                // Raccogli ingredienti
                const ingredientTags = document.querySelectorAll('#pizzaIngredients .tag');
                const ingredients = Array.from(ingredientTags).map(tag => tag.textContent.trim().replace('√ó', ''));
                
                // Validazione ingredienti
                if (ingredients.length === 0) {
                    alert('Aggiungi almeno un ingrediente');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salva';
                    return;
                }
                
                // Raccogli dati dal form
                const pizzaId = document.getElementById('pizzaId').value;
                const pizzaData = {
                    name: document.getElementById('pizzaName').value,
                    price: parseFloat(document.getElementById('pizzaPrice').value),
                    category: document.getElementById('pizzaCategory').value,
                    description: document.getElementById('pizzaDescription').value,
                    ingredients: ingredients,
                    badge: document.getElementById('pizzaBadge').value,
                    status: parseInt(document.getElementById('pizzaStatus').value),
                    featured: document.getElementById('pizzaFeatured').checked,
                    largeTitle: document.getElementById('pizzaLargeTitle').checked
                };
                
                // Ottieni l'immagine
                const fileInput = document.getElementById('pizzaImage');
                const imageFile = fileInput.files.length > 0 ? fileInput.files[0] : null;
                
                // Se l'immagine non √® cambiata e abbiamo gi√† un'immagine, mantieni l'URL esistente
                if (!imageFile && document.getElementById('previewImage').src && !document.getElementById('previewImage').src.includes('data:image')) {
                    pizzaData.image = document.getElementById('previewImage').src;
                }
                
                // Se √® un inserimento o aggiornamento
                if (pizzaId) {
                    // √à un aggiornamento
                    await updatePizza(pizzaId, pizzaData, imageFile);
                    showSuccessAlert('Pizza aggiornata con successo!');
                } else {
                    // √à un inserimento
                    await addPizza(pizzaData, imageFile);
                    showSuccessAlert('Pizza aggiunta con successo!');
                }
                
                // Aggiorna la tabella
                const pizze = await loadPizzas();
                loadPizzaTable(pizze);
                
                // Chiudi il modal
                document.getElementById('pizzaModal').classList.remove('show');
                document.getElementById('modalBackdrop').classList.remove('show');
                
            } catch (error) {
                console.error("Errore durante il salvataggio della pizza:", error);
                alert(`Errore durante il salvataggio: ${error.message}`);
            } finally {
                // Riabilita il pulsante di invio
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salva';
            }
        });

        // Event listener per eliminare una pizza
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            const pizzaId = this.getAttribute('data-id');
            
            try {
                await deletePizza(pizzaId);
                
                // Aggiorna la tabella
                const pizze = await loadPizzas();
                loadPizzaTable(pizze);
                
                // Mostra messaggio di successo
                showSuccessAlert('Pizza eliminata con successo!');
            } catch (error) {
                console.error("Errore durante l'eliminazione della pizza:", error);
                alert(`Errore durante l'eliminazione: ${error.message}`);
            }
            
            // Chiudi il modal
            document.getElementById('deleteModal').classList.remove('show');
            document.getElementById('modalBackdrop').classList.remove('show');
        });
        
        // Funzione per caricare la tabella delle pizze
        function loadPizzaTable(data) {
            const tableBody = document.getElementById('pizzaTableBody');
            tableBody.innerHTML = '';
            
            data.forEach(pizza => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${pizza.image}" alt="${pizza.name}" class="img-thumbnail"></td>
                    <td>${pizza.name}</td>
                    <td>${categoryMap[pizza.category]}</td>
                    <td>‚Ç¨ ${pizza.price.toFixed(2)}</td>
                    <td>${pizza.status === 1 ? '<span class="badge badge-success">Attiva</span>' : '<span class="badge badge-danger">Disattiva</span>'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-primary edit-btn" data-id="${pizza.id}">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${pizza.id}" data-name="${pizza.name}">üóëÔ∏è</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Aggiungi event listener ai pulsanti dopo averli creati
            addButtonEventListeners();
        }
        
        // Funzione per aggiungere event listener ai pulsanti
        function addButtonEventListeners() {
            // Edit buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const pizzaId = this.getAttribute('data-id');
                    openEditModal(pizzaId);
                });
            });
            
            // Delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pizzaId = this.getAttribute('data-id');
                    const pizzaName = this.getAttribute('data-name');
                    openDeleteModal(pizzaId, pizzaName);
                });
            });
        }
        
        // Funzione per aprire il modal di modifica
        async function openEditModal(pizzaId) {
            try {
                const pizza = await getPizza(pizzaId);
                
                // Imposta i valori del form
                document.getElementById('pizzaId').value = pizza.id;
                document.getElementById('pizzaName').value = pizza.name;
                document.getElementById('pizzaPrice').value = pizza.price;
                document.getElementById('pizzaCategory').value = pizza.category;
                document.getElementById('pizzaDescription').value = pizza.description;
                document.getElementById('pizzaBadge').value = pizza.badge || '';
                document.getElementById('pizzaStatus').value = pizza.status;
                document.getElementById('pizzaFeatured').checked = pizza.featured;
                document.getElementById('pizzaLargeTitle').checked = pizza.largeTitle;
                
                // Popola ingredienti
                const tagsInput = document.getElementById('pizzaIngredients');
                tagsInput.innerHTML = '<input type="text" placeholder="Aggiungi ingrediente e premi Enter" id="ingredientInput">'; // Pulisci i tag esistenti e ripristina l'input
                const ingredientInputRef = document.getElementById('ingredientInput'); 
                pizza.ingredients.forEach(ingredient => {
                    addIngredientTag(ingredient); 
                });
                // L'input √® gi√† all'interno di tagsInput, non serve ri-appendere se lo si ricrea come sopra.
                // Se non si ricrea l'input, allora serve: tagsInput.appendChild(ingredientInputRef);
                
                // Mostra anteprima immagine
                const previewImgElement = document.getElementById('previewImage');
                const imagePreviewContainer = document.getElementById('imagePreview');
                if (pizza.image) {
                    previewImgElement.src = pizza.image;
                    imagePreviewContainer.style.display = 'flex';
                } else {
                    previewImgElement.src = '';
                    imagePreviewContainer.style.display = 'none';
                }
                
                // Cambia il titolo del modal
                document.getElementById('modalTitle').textContent = 'Modifica Pizza';
                
                // Mostra il modal
                pizzaModal.classList.add('show');
                modalBackdrop.classList.add('show');
            } catch (error) {
                console.error("Errore durante il recupero della pizza:", error);
                alert(`Errore durante il recupero della pizza: ${error.message}`);
            }
        }

        // Variabili per il modal e form (alcune potrebbero essere gi√† definite sopra)
        // const pizzaModal = document.getElementById('pizzaModal'); // Gi√† definito
        // const modalBackdrop = document.getElementById('modalBackdrop'); // Gi√† definito
        const addPizzaBtn = document.getElementById('addPizzaBtn');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const modalTitle = document.getElementById('modalTitle');
        // const pizzaForm = document.getElementById('pizzaForm'); // Gi√† definito

        // Variabili per il delete modal
        // const deleteModal = document.getElementById('deleteModal'); // Gi√† definito
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); // Gi√† definito
        const deletePizzaName = document.getElementById('deletePizzaName');

        // Variabili per il carousel modal
        const carouselModal = document.getElementById('carouselModal');
        const addCarouselBtn = document.getElementById('addCarouselBtn');
        const closeCarouselModal = document.getElementById('closeCarouselModal');
        const cancelCarouselBtn = document.getElementById('cancelCarouselBtn');
        const carouselForm = document.getElementById('carouselForm');

        // Variabili per i modals dei valori
        const valoreModal = document.getElementById('valoreModal');
        const addValoreBtn = document.getElementById('addValoreBtn');
        const closeValoreModal = document.getElementById('closeValoreModal');
        const cancelValoreBtn = document.getElementById('cancelValoreBtn');
        const valoreForm = document.getElementById('valoreForm');

        // Variabili per i modals degli ingredienti
        const ingredienteModal = document.getElementById('ingredienteModal');
        const addIngredienteBtn = document.getElementById('addIngredienteBtn');
        const closeIngredienteModal = document.getElementById('closeIngredienteModal');
        const cancelIngredienteBtn = document.getElementById('cancelIngredienteBtn');
        const ingredienteForm = document.getElementById('ingredienteForm');

        // Variabili per i modals della galleria
        const galleryModal = document.getElementById('galleryModal');
        const addLocaleImageBtn = document.getElementById('addLocaleImageBtn');
        const closeGalleryModal = document.getElementById('closeGalleryModal');
        const cancelGalleryBtn = document.getElementById('cancelGalleryBtn');
        const galleryForm = document.getElementById('galleryForm');

        // Cerca pizze
        document.getElementById('searchPizza').addEventListener('input', async function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const pizze = await loadPizzas(); // Ricarica le pizze per il filtro
            const filteredPizze = pizze.filter(pizza => 
                pizza.name.toLowerCase().includes(searchTerm) || 
                pizza.description.toLowerCase().includes(searchTerm) ||
                (pizza.ingredients && pizza.ingredients.some(ing => ing.toLowerCase().includes(searchTerm)))
            );
            loadPizzaTable(filteredPizze);
        });

        // Funzione per aprire il modal di eliminazione
        function openDeleteModal(pizzaId, pizzaNameText) {
            // Salva l'ID della pizza da eliminare
            confirmDeleteBtn.setAttribute('data-id', pizzaId);
            
            // Imposta il nome della pizza
            deletePizzaName.textContent = pizzaNameText;
            
            // Mostra il modal
            deleteModal.classList.add('show');
            modalBackdrop.classList.add('show');
        }

        // Funzione per mostrare il successo alert - spostata all'inizio del DOMContentLoaded

        // Gestione degli ingredienti come tag
        const ingredientInput = document.getElementById('ingredientInput');
        
        ingredientInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = this.value.trim();
                if (value) {
                    addIngredientTag(value);
                    this.value = '';
                }
            }
        });
        
        function addIngredientTag(text) {
            const tagsInputContainer = document.getElementById('pizzaIngredients');
            const currentInput = document.getElementById('ingredientInput'); // L'input field
            
            if (!currentInput) {
                console.error("Input field 'ingredientInput' non trovato dentro 'pizzaIngredients'");
                return;
            }

            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.innerHTML = `
                ${text}
                <span class="tag-remove">√ó</span>
            `;
            
            tag.querySelector('.tag-remove').addEventListener('click', function() {
                tagsInputContainer.removeChild(tag);
            });
            
            // Inserisci il tag prima dell'input field
            tagsInputContainer.insertBefore(tag, currentInput);
        }

        // Gestione dell'upload immagine per le pizze
        const dropzone = document.getElementById('pizzaImageDropzone');
        const fileInput = document.getElementById('pizzaImage');
        const removeImageBtn = document.getElementById('removeImage');

        dropzone.addEventListener('click', function() {
            fileInput.click();
        });

        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'var(--primary-light)';
        });

        dropzone.addEventListener('dragleave', function() {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
        });

        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleImageSelection(fileInput, 'previewImage', 'imagePreview');
            }
        });

        fileInput.addEventListener('change', function() {
            handleImageSelection(this, 'previewImage', 'imagePreview');
        });

        function handleImageSelection(input, previewId, previewContainerId) {
            if (input.files.length > 0) {
                const file = input.files[0];
                
                // Controlla se √® un'immagine
                if (!file.type.startsWith('image/')) {
                    alert('Per favore seleziona un immagine valida.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(previewContainerId).style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        }

        removeImageBtn.addEventListener('click', function() {
            fileInput.value = ''; // Resetta l'input file
            document.getElementById('previewImage').src = ''; // Rimuovi l'URL dall'img src
            document.getElementById('imagePreview').style.display = 'none';
        });

        // Gestione dell'upload immagine per il carosello
        const carouselDropzone = document.getElementById('carouselImageDropzone');
        const carouselFileInput = document.getElementById('carouselImage');
        const removeCarouselImageBtn = document.getElementById('removeCarouselImage');

        carouselDropzone.addEventListener('click', function() {
            carouselFileInput.click();
        });

        carouselDropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'var(--primary-light)';
        });

        carouselDropzone.addEventListener('dragleave', function() {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
        });

        carouselDropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                carouselFileInput.files = e.dataTransfer.files;
                handleImageSelection(carouselFileInput, 'carouselPreviewImage', 'carouselImagePreview');
            }
        });

        carouselFileInput.addEventListener('change', function() {
            handleImageSelection(this, 'carouselPreviewImage', 'carouselImagePreview');
        });

        removeCarouselImageBtn.addEventListener('click', function() {
            carouselFileInput.value = '';
            document.getElementById('carouselImagePreview').style.display = 'none';
        });

        // Event listeners per modals
        addPizzaBtn.addEventListener('click', function() {
            // Reset form
            pizzaForm.reset();
            document.getElementById('pizzaId').value = ''; // Assicurati che l'ID sia vuoto per un nuovo inserimento
            
            // Pulisci gli ingredienti
            const tagsInputContainer = document.getElementById('pizzaIngredients');
            const currentInput = document.getElementById('ingredientInput');
            tagsInputContainer.innerHTML = ''; // Rimuovi tutti i figli (tag)
            // Ricrea l'input field se non esiste pi√π o √® stato rimosso
            if (!tagsInputContainer.querySelector('#ingredientInput')) {
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.placeholder = 'Aggiungi ingrediente e premi Enter';
                newInput.id = 'ingredientInput';
                tagsInputContainer.appendChild(newInput);
                // Riassegna l'event listener se l'input √® stato ricreato
                newInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const value = this.value.trim();
                        if (value) {
                            addIngredientTag(value);
                            this.value = '';
                        }
                    }
                });
            } else {
                 currentInput.value = ''; // Pulisci il valore dell'input esistente
            }
            
            // Nascondi anteprima immagine e resetta src
            document.getElementById('previewImage').src = '';
            document.getElementById('imagePreview').style.display = 'none';
            fileInput.value = ''; // Resetta l'input file
            
            // Cambia il titolo del modal
            modalTitle.textContent = 'Aggiungi Pizza';
            
            // Mostra il modal
            pizzaModal.classList.add('show');
            modalBackdrop.classList.add('show');
        });

        closeModal.addEventListener('click', function() {
            pizzaModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelBtn.addEventListener('click', function() {
            pizzaModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        closeDeleteModal.addEventListener('click', function() {
            deleteModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelDeleteBtn.addEventListener('click', function() {
            deleteModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Carosello event listeners
        addCarouselBtn.addEventListener('click', function() {
            // Reset form
            carouselForm.reset();
            
            // Nascondi anteprima immagine
            document.getElementById('carouselImagePreview').style.display = 'none';
            
            // Aggiorna titolo
            document.getElementById('carouselModalTitle').textContent = 'Aggiungi Immagine Carosello';
            
            // Mostra il modal
            carouselModal.classList.add('show');
            modalBackdrop.classList.add('show');
        });

        closeCarouselModal.addEventListener('click', function() {
            carouselModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelCarouselBtn.addEventListener('click', function() {
            carouselModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Submit del form carosello
        carouselForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validazione immagine
            const imagePreview = document.getElementById('carouselImagePreview');
            if (imagePreview.style.display === 'none') {
                alert('Seleziona un\'immagine per il carosello');
                return;
            }
            
            // In un'implementazione reale, qui salveresti l'immagine
            showSuccessAlert('Immagine carosello salvata con successo!', carouselSuccessAlert, carouselSuccessMessage);
            
            // Chiudi il modal
            carouselModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Gestione ordine carosello
        document.getElementById('saveOrderBtn').addEventListener('click', function() {
            showSuccessAlert('Ordine salvato con successo!', carouselSuccessAlert, carouselSuccessMessage);
        });

        // Edit carosello buttons
        document.querySelectorAll('.edit-carousel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Ottieni l'immagine del carosello
                const carouselItem = this.closest('.carousel-item');
                const img = carouselItem.querySelector('img');
                
                // Popola il form
                document.getElementById('carouselAlt').value = img.alt;
                document.getElementById('carouselPreviewImage').src = img.src;
                document.getElementById('carouselImagePreview').style.display = 'flex';
                
                // Aggiorna titolo
                document.getElementById('carouselModalTitle').textContent = 'Modifica Immagine Carosello';
                
                // Mostra il modal
                carouselModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
        });

        // Delete carosello buttons
        document.querySelectorAll('.delete-carousel-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
                    // In un'implementazione reale, qui elimineresti l'immagine
                    this.closest('.carousel-item').remove();
                    showSuccessAlert('Immagine eliminata con successo!', carouselSuccessAlert, carouselSuccessMessage);
                }
            });
        });

        // Gestione immagine storia
        const storiaDropzone = document.getElementById('storiaImageDropzone');
        const storiaFileInput = document.getElementById('storiaImage');

        storiaDropzone.addEventListener('click', function() {
            storiaFileInput.click();
        });

        storiaDropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'var(--primary-light)';
        });

        storiaDropzone.addEventListener('dragleave', function() {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
        });

        storiaDropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                storiaFileInput.files = e.dataTransfer.files;
                const file = e.dataTransfer.files[0];
                
                if (!file.type.startsWith('image/')) {
                    alert('Per favore seleziona un immagine valida.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('storiaImagePreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        storiaFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const file = this.files[0];
                
                if (!file.type.startsWith('image/')) {
                    alert('Per favore seleziona un immagine valida.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('storiaImagePreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Salva modifiche storia
        document.getElementById('saveStoria').addEventListener('click', function() {
            // In un'implementazione reale, qui salveresti i dati
            showSuccessAlert('Modifiche salvate con successo!', storiaSuccessAlert, storiaSuccessMessage);
        });

        // Gestione editor WYSIWYG semplice
        document.querySelectorAll('.wysiwyg-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const content = document.getElementById('storiaContent');
                
                if (this.classList.contains('bold-btn')) {
                    document.execCommand('bold', false, null);
                } else if (this.classList.contains('italic-btn')) {
                    document.execCommand('italic', false, null);
                } else if (this.classList.contains('underline-btn')) {
                    document.execCommand('underline', false, null);
                } else if (this.classList.contains('paragraph-btn')) {
                    document.execCommand('formatBlock', false, '<p>');
                }
                
                content.focus();
            });
        });

        // Valori
        // Mostra modal per aggiungere valore
        addValoreBtn.addEventListener('click', function() {
            // Reset form
            valoreForm.reset();
            
            // Aggiorna titolo
            document.getElementById('valoreModalTitle').textContent = 'Aggiungi Valore';
            
            // Mostra il modal
            valoreModal.classList.add('show');
            modalBackdrop.classList.add('show');
        });

        closeValoreModal.addEventListener('click', function() {
            valoreModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelValoreBtn.addEventListener('click', function() {
            valoreModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Edit valore buttons
        document.querySelectorAll('.edit-valore-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const valoreCard = this.closest('.value-card');
                
                // Popola il form
                document.getElementById('valoreIcon').value = valoreCard.querySelector('.value-icon').textContent;
                document.getElementById('valoreTitolo').value = valoreCard.querySelector('.value-title').textContent;
                document.getElementById('valoreDescrizione').value = valoreCard.querySelector('.value-description').textContent;
                
                // Aggiorna titolo
                document.getElementById('valoreModalTitle').textContent = 'Modifica Valore';
                
                // Mostra il modal
                valoreModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
        });

        // Delete valore buttons
        document.querySelectorAll('.delete-valore-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questo valore?')) {
                    // In un'implementazione reale, qui elimineresti il valore
                    this.closest('.value-card').remove();
                    showSuccessAlert('Valore eliminato con successo!', valoriSuccessAlert, valoriSuccessMessage);
                }
            });
        });

        // Submit del form valore
        valoreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Raccogli dati dal form
            const valoreData = {
                icon: document.getElementById('valoreIcon').value,
                title: document.getElementById('valoreTitolo').value,
                description: document.getElementById('valoreDescrizione').value
            };
            
            // In un'implementazione reale, qui salveresti i dati
            showSuccessAlert('Valore salvato con successo!', valoriSuccessAlert, valoriSuccessMessage);
            
            // Aggiungi nuovo valore o aggiorna esistente (simulazione)
            const valoriContainer = document.getElementById('valoriContainer');
            
            // In questo esempio aggiungiamo sempre un nuovo valore
            const newValoreCard = document.createElement('div');
            newValoreCard.className = 'value-card';
            newValoreCard.innerHTML = `
                <div class="value-icon">${valoreData.icon}</div>
                <h3 class="value-title">${valoreData.title}</h3>
                <p class="value-description">${valoreData.description}</p>
                <div class="value-actions">
                    <button class="btn btn-sm btn-secondary edit-valore-btn">Modifica</button>
                    <button class="btn btn-sm btn-danger delete-valore-btn">Elimina</button>
                </div>
            `;
            
            // Aggiungi event listeners ai nuovi pulsanti
            newValoreCard.querySelector('.edit-valore-btn').addEventListener('click', function() {
                const valoreCard = this.closest('.value-card');
                
                // Popola il form
                document.getElementById('valoreIcon').value = valoreCard.querySelector('.value-icon').textContent;
                document.getElementById('valoreTitolo').value = valoreCard.querySelector('.value-title').textContent;
                document.getElementById('valoreDescrizione').value = valoreCard.querySelector('.value-description').textContent;
                
                // Aggiorna titolo
                document.getElementById('valoreModalTitle').textContent = 'Modifica Valore';
                
                // Mostra il modal
                valoreModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
            
            newValoreCard.querySelector('.delete-valore-btn').addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questo valore?')) {
                    this.closest('.value-card').remove();
                    showSuccessAlert('Valore eliminato con successo!', valoriSuccessAlert, valoriSuccessMessage);
                }
            });
            
            valoriContainer.appendChild(newValoreCard);
            
            // Chiudi il modal
            valoreModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Salva ordine valori
        document.getElementById('saveValoriOrderBtn').addEventListener('click', function() {
            showSuccessAlert('Ordine salvato con successo!', valoriSuccessAlert, valoriSuccessMessage);
        });

        // Ingredienti
        // Mostra modal per aggiungere ingrediente
        addIngredienteBtn.addEventListener('click', function() {
            // Reset form
            ingredienteForm.reset();
            
            // Nascondi anteprima immagine
            document.getElementById('ingredienteImagePreview').style.display = 'none';
            
            // Aggiorna titolo
            document.getElementById('ingredienteModalTitle').textContent = 'Aggiungi Ingrediente';
            
            // Mostra il modal
            ingredienteModal.classList.add('show');
            modalBackdrop.classList.add('show');
        });

        closeIngredienteModal.addEventListener('click', function() {
            ingredienteModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelIngredienteBtn.addEventListener('click', function() {
            ingredienteModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Gestione immagine ingrediente
        const ingredienteDropzone = document.getElementById('ingredienteImageDropzone');
        const ingredienteFileInput = document.getElementById('ingredienteImage');
        const removeIngredienteImageBtn = document.getElementById('removeIngredienteImage');

        ingredienteDropzone.addEventListener('click', function() {
            ingredienteFileInput.click();
        });

        ingredienteDropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'var(--primary-light)';
        });

        ingredienteDropzone.addEventListener('dragleave', function() {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
        });

        ingredienteDropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                ingredienteFileInput.files = e.dataTransfer.files;
                handleImageSelection(ingredienteFileInput, 'ingredientePreviewImage', 'ingredienteImagePreview');
            }
        });

        ingredienteFileInput.addEventListener('change', function() {
            handleImageSelection(this, 'ingredientePreviewImage', 'ingredienteImagePreview');
        });

        removeIngredienteImageBtn.addEventListener('click', function() {
            ingredienteFileInput.value = '';
            document.getElementById('ingredienteImagePreview').style.display = 'none';
        });

        // Edit ingrediente buttons
        document.querySelectorAll('.edit-ingrediente-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const ingredienteCard = this.closest('.ingredient-card');
                
                // Popola il form
                document.getElementById('ingredienteTitolo').value = ingredienteCard.querySelector('.ingredient-title').textContent;
                document.getElementById('ingredienteDescrizione').value = ingredienteCard.querySelector('.ingredient-description').textContent;
                document.getElementById('ingredienteBadge').value = ingredienteCard.querySelector('.ingredient-badge').textContent;
                
                // Mostra anteprima immagine
                document.getElementById('ingredientePreviewImage').src = ingredienteCard.querySelector('.ingredient-img').src;
                document.getElementById('ingredienteImagePreview').style.display = 'flex';
                
                // Aggiorna titolo
                document.getElementById('ingredienteModalTitle').textContent = 'Modifica Ingrediente';
                
                // Mostra il modal
                ingredienteModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
        });

        // Delete ingrediente buttons
        document.querySelectorAll('.delete-ingrediente-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questo ingrediente?')) {
                    // In un'implementazione reale, qui elimineresti l'ingrediente
                    this.closest('.ingredient-card').remove();
                    showSuccessAlert('Ingrediente eliminato con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
                }
            });
        });

        // Submit del form ingrediente
        ingredienteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validazione immagine
            const imagePreview = document.getElementById('ingredienteImagePreview');
            if (imagePreview.style.display === 'none') {
                alert('Seleziona un\'immagine per l\'ingrediente');
                return;
            }
            
            // Raccogli dati dal form
            const ingredienteData = {
                title: document.getElementById('ingredienteTitolo').value,
                description: document.getElementById('ingredienteDescrizione').value,
                badge: document.getElementById('ingredienteBadge').value,
                image: document.getElementById('ingredientePreviewImage').src
            };
            
            // In un'implementazione reale, qui salveresti i dati
            showSuccessAlert('Ingrediente salvato con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
            
            // Aggiungi nuovo ingrediente o aggiorna esistente (simulazione)
            const ingredientiContainer = document.getElementById('ingredientiContainer');
            
            // In questo esempio aggiungiamo sempre un nuovo ingrediente
            const newIngredienteCard = document.createElement('div');
            newIngredienteCard.className = 'ingredient-card';
            newIngredienteCard.innerHTML = `
                <img src="${ingredienteData.image}" alt="${ingredienteData.title}" class="ingredient-img">
                <div class="ingredient-content">
                    <h3 class="ingredient-title">${ingredienteData.title}</h3>
                    <p class="ingredient-description">${ingredienteData.description}</p>
                    <span class="ingredient-badge">${ingredienteData.badge}</span>
                    <div class="ingredient-actions">
                        <button class="btn btn-sm btn-secondary edit-ingrediente-btn">Modifica</button>
                        <button class="btn btn-sm btn-danger delete-ingrediente-btn">Elimina</button>
                    </div>
                </div>
            `;
            
            // Aggiungi event listeners ai nuovi pulsanti
            newIngredienteCard.querySelector('.edit-ingrediente-btn').addEventListener('click', function() {
                const ingredienteCard = this.closest('.ingredient-card');
                
                // Popola il form
                document.getElementById('ingredienteTitolo').value = ingredienteCard.querySelector('.ingredient-title').textContent;
                document.getElementById('ingredienteDescrizione').value = ingredienteCard.querySelector('.ingredient-description').textContent;
                document.getElementById('ingredienteBadge').value = ingredienteCard.querySelector('.ingredient-badge').textContent;
                
                // Mostra anteprima immagine
                document.getElementById('ingredientePreviewImage').src = ingredienteCard.querySelector('.ingredient-img').src;
                document.getElementById('ingredienteImagePreview').style.display = 'flex';
                
                // Aggiorna titolo
                document.getElementById('ingredienteModalTitle').textContent = 'Modifica Ingrediente';
                
                // Mostra il modal
                ingredienteModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
            
            newIngredienteCard.querySelector('.delete-ingrediente-btn').addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questo ingrediente?')) {
                    this.closest('.ingredient-card').remove();
                    showSuccessAlert('Ingrediente eliminato con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
                }
            });
            
            ingredientiContainer.appendChild(newIngredienteCard);
            
            // Chiudi il modal
            ingredienteModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Salva introduzione ingredienti
        document.getElementById('saveIngredientiIntroBtn').addEventListener('click', function() {
            showSuccessAlert('Introduzione salvata con successo!', ingredientiSuccessAlert, ingredientiSuccessMessage);
        });

        // Locale / Galleria
        // Mostra modal per aggiungere immagine galleria
        addLocaleImageBtn.addEventListener('click', function() {
            // Reset form
            galleryForm.reset();
            
            // Nascondi anteprima immagine
            document.getElementById('galleryImagePreview').style.display = 'none';
            
            // Aggiorna titolo
            document.getElementById('galleryModalTitle').textContent = 'Aggiungi Immagine Galleria';
            
            // Mostra il modal
            galleryModal.classList.add('show');
            modalBackdrop.classList.add('show');
        });

        closeGalleryModal.addEventListener('click', function() {
            galleryModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelGalleryBtn.addEventListener('click', function() {
            galleryModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Gestione immagine galleria
        const galleryDropzone = document.getElementById('galleryImageDropzone');
        const galleryFileInput = document.getElementById('galleryImage');
        const removeGalleryImageBtn = document.getElementById('removeGalleryImage');

        galleryDropzone.addEventListener('click', function() {
            galleryFileInput.click();
        });

        galleryDropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--primary)';
            this.style.backgroundColor = 'var(--primary-light)';
        });

        galleryDropzone.addEventListener('dragleave', function() {
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
        });

        galleryDropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ced4da';
            this.style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                galleryFileInput.files = e.dataTransfer.files;
                handleImageSelection(galleryFileInput, 'galleryPreviewImage', 'galleryImagePreview');
            }
        });

        galleryFileInput.addEventListener('change', function() {
            handleImageSelection(this, 'galleryPreviewImage', 'galleryImagePreview');
        });

        removeGalleryImageBtn.addEventListener('click', function() {
            galleryFileInput.value = '';
            document.getElementById('galleryImagePreview').style.display = 'none';
        });

        // Edit gallery buttons
        document.querySelectorAll('.edit-gallery-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const galleryItem = this.closest('.gallery-item');
                const img = galleryItem.querySelector('img');
                const caption = galleryItem.querySelector('.gallery-item-caption');
                
                // Popola il form
                document.getElementById('galleryCaption').value = caption.textContent;
                document.getElementById('galleryAlt').value = img.alt;
                document.getElementById('galleryPreviewImage').src = img.src;
                document.getElementById('galleryImagePreview').style.display = 'flex';
                
                // Aggiorna titolo
                document.getElementById('galleryModalTitle').textContent = 'Modifica Immagine Galleria';
                
                // Mostra il modal
                galleryModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
        });

        // Delete gallery buttons
        document.querySelectorAll('.delete-gallery-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
                    // In un'implementazione reale, qui elimineresti l'immagine
                    this.closest('.gallery-item').remove();
                    showSuccessAlert('Immagine eliminata con successo!', localeSuccessAlert, localeSuccessMessage);
                }
            });
        });

        // Submit del form galleria
        galleryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validazione immagine
            const imagePreview = document.getElementById('galleryImagePreview');
            if (imagePreview.style.display === 'none') {
                alert('Seleziona un\'immagine per la galleria');
                return;
            }
            
            // Raccogli dati dal form
            const galleryData = {
                caption: document.getElementById('galleryCaption').value,
                alt: document.getElementById('galleryAlt').value,
                image: document.getElementById('galleryPreviewImage').src
            };
            
            // In un'implementazione reale, qui salveresti i dati
            showSuccessAlert('Immagine galleria salvata con successo!', localeSuccessAlert, localeSuccessMessage);
            
            // Aggiungi nuova immagine o aggiorna esistente (simulazione)
            const galleryContainer = document.getElementById('galleryContainer');
            
            // In questo esempio aggiungiamo sempre una nuova immagine
            const newGalleryItem = document.createElement('div');
            newGalleryItem.className = 'gallery-item';
            newGalleryItem.innerHTML = `
                <img src="${galleryData.image}" alt="${galleryData.alt}">
                <div class="gallery-item-overlay">
                    <div class="gallery-item-caption">${galleryData.caption}</div>
                    <div class="gallery-item-actions">
                        <button class="btn btn-sm btn-secondary edit-gallery-btn">üìù</button>
                        <button class="btn btn-sm btn-danger delete-gallery-btn">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            
            // Aggiungi event listeners ai nuovi pulsanti
            newGalleryItem.querySelector('.edit-gallery-btn').addEventListener('click', function() {
                const galleryItem = this.closest('.gallery-item');
                const img = galleryItem.querySelector('img');
                const caption = galleryItem.querySelector('.gallery-item-caption');
                
                // Popola il form
                document.getElementById('galleryCaption').value = caption.textContent;
                document.getElementById('galleryAlt').value = img.alt;
                document.getElementById('galleryPreviewImage').src = img.src;
                document.getElementById('galleryImagePreview').style.display = 'flex';
                
                // Aggiorna titolo
                document.getElementById('galleryModalTitle').textContent = 'Modifica Immagine Galleria';
                
                // Mostra il modal
                galleryModal.classList.add('show');
                modalBackdrop.classList.add('show');
            });
            
            newGalleryItem.querySelector('.delete-gallery-btn').addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questa immagine?')) {
                    this.closest('.gallery-item').remove();
                    showSuccessAlert('Immagine eliminata con successo!', localeSuccessAlert, localeSuccessMessage);
                }
            });
            
            galleryContainer.appendChild(newGalleryItem);
            
            // Chiudi il modal
            galleryModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Salva introduzione locale
        document.getElementById('saveLocaleIntroBtn').addEventListener('click', function() {
            showSuccessAlert('Introduzione salvata con successo!', localeSuccessAlert, localeSuccessMessage);
        });

        // Salva ordine galleria
        document.getElementById('saveGalleryOrderBtn').addEventListener('click', function() {
            showSuccessAlert('Ordine salvato con successo!', localeSuccessAlert, localeSuccessMessage);
        });        // SEZIONE TEAM
        async function loadTeamData() {
            try {
                const settings = await loadTeamSettings();
                document.getElementById('teamTitolo').value = settings.titolo || 'Il Nostro Team';
                document.getElementById('teamIntro').value = settings.introduzione || 'Dietro ogni pizza perfetta c\'√® una squadra appassionata e dedicata. Conosciamo le persone che ogni giorno lavorano con passione per offrirti l\'esperienza PIZZIAMO?!';
                
                const team = await loadTeam();
                displayTeam(team);
            } catch (error) {
                console.error("Errore durante il caricamento del team:", error);
                showSuccessAlert("Errore durante il caricamento del team", teamSuccessAlert, teamSuccessMessage, "error");
            }
        }

        function displayTeam(team) {
            const container = document.getElementById('teamContainer');
            container.innerHTML = '';
            
            team.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'team-member-card';
                memberElement.setAttribute('data-id', member.id);
                memberElement.innerHTML = `
                    <div class="team-member-status ${member.status === 1 ? 'active' : 'inactive'}">
                        ${member.status === 1 ? 'Attivo' : 'Nascosto'}
                    </div>
                    <img src="${member.image}" alt="${member.nome}" class="team-member-photo">
                    <h3 class="team-member-name">${member.nome}</h3>
                    <p class="team-member-role">${member.ruolo}</p>
                    <p class="team-member-description">${member.descrizione}</p>
                    ${member.social ? `
                        <div class="team-member-social">
                            ${member.social.facebook ? `<a href="${member.social.facebook}" target="_blank">üìò</a>` : ''}
                            ${member.social.instagram ? `<a href="${member.social.instagram}" target="_blank">üì∑</a>` : ''}
                            ${member.social.twitter ? `<a href="${member.social.twitter}" target="_blank">üê¶</a>` : ''}
                        </div>
                    ` : ''}
                    <div class="team-member-actions">
                        <button class="btn btn-sm btn-secondary edit-team-btn" data-id="${member.id}">Modifica</button>
                        <button class="btn btn-sm btn-danger delete-team-btn" data-id="${member.id}">Elimina</button>
                    </div>
                `;
                container.appendChild(memberElement);
            });
            
            setupTeamEventListeners();
        }

        function setupTeamEventListeners() {
            document.querySelectorAll('.edit-team-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const memberId = this.getAttribute('data-id');
                    try {
                        const teamMembers = await loadTeam();
                        const member = teamMembers.find(m => m.id === memberId);
                        
                        if (member) {
                            document.getElementById('teamMemberId').value = member.id;
                            document.getElementById('teamNome').value = member.nome;
                            document.getElementById('teamRuolo').value = member.ruolo;
                            document.getElementById('teamDescrizione').value = member.descrizione;
                            document.getElementById('teamOrdine').value = member.ordine;
                            document.getElementById('teamStatus').value = member.status;
                            
                            // Popola social media
                            document.getElementById('teamFacebook').value = member.social?.facebook || '';
                            document.getElementById('teamInstagram').value = member.social?.instagram || '';
                            document.getElementById('teamTwitter').value = member.social?.twitter || '';
                            
                            // Mostra anteprima immagine
                            document.getElementById('teamPreviewImage').src = member.image;
                            document.getElementById('teamImagePreview').style.display = 'flex';
                            
                            document.getElementById('teamModalTitle').textContent = 'Modifica Membro del Team';
                            teamModal.classList.add('show');
                            modalBackdrop.classList.add('show');
                        }
                    } catch (error) {
                        console.error("Errore durante il recupero del membro:", error);
                        alert("Errore durante il recupero del membro");
                    }
                });
            });

            document.querySelectorAll('.delete-team-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (confirm('Sei sicuro di voler eliminare questo membro del team?')) {
                        const memberId = this.getAttribute('data-id');
                        try {
                            await deleteTeamMember(memberId);
                            await loadTeamData();
                            showSuccessAlert('Membro del team eliminato con successo!', teamSuccessAlert, teamSuccessMessage);
                        } catch (error) {
                            console.error("Errore durante l'eliminazione:", error);
                            alert("Errore durante l'eliminazione del membro");
                        }
                    }
                });
            });
        }

        // Team variables e event handlers
        const teamModal = document.getElementById('teamModal');
        const addTeamMemberBtn = document.getElementById('addTeamMemberBtn');
        const closeTeamModal = document.getElementById('closeTeamModal');
        const cancelTeamBtn = document.getElementById('cancelTeamBtn');
        const teamForm = document.getElementById('teamForm');
        const teamSuccessAlert = document.getElementById('teamSuccessAlert');
        const teamSuccessMessage = document.getElementById('teamSuccessMessage');
        const teamFileInput = document.getElementById('teamImage');
        const removeTeamImageBtn = document.getElementById('removeTeamImage');

        // Team handlers
        addTeamMemberBtn.addEventListener('click', function() {
            teamForm.reset();
            document.getElementById('teamMemberId').value = '';
            document.getElementById('teamImagePreview').style.display = 'none';
            document.getElementById('teamModalTitle').textContent = 'Aggiungi Membro del Team';
            teamModal.classList.add('show');
            modalBackdrop.classList.add('show');
        });

        closeTeamModal.addEventListener('click', function() {
            teamModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        cancelTeamBtn.addEventListener('click', function() {
            teamModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });

        // Team image handling
        document.getElementById('teamImageDropzone').addEventListener('click', function() {
            teamFileInput.click();
        });

        teamFileInput.addEventListener('change', function() {
            handleImageSelection(this, 'teamPreviewImage', 'teamImagePreview');
        });

        removeTeamImageBtn.addEventListener('click', function() {
            teamFileInput.value = '';
            document.getElementById('teamImagePreview').style.display = 'none';
        });

        // Team form submission
        teamForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveTeamBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvataggio...';
            
            try {
                const memberId = document.getElementById('teamMemberId').value;
                const memberData = {
                    nome: document.getElementById('teamNome').value,
                    ruolo: document.getElementById('teamRuolo').value,
                    descrizione: document.getElementById('teamDescrizione').value,
                    ordine: parseInt(document.getElementById('teamOrdine').value),
                    status: parseInt(document.getElementById('teamStatus').value),
                    social: {
                        facebook: document.getElementById('teamFacebook').value || null,
                        instagram: document.getElementById('teamInstagram').value || null,
                        twitter: document.getElementById('teamTwitter').value || null
                    }
                };

                // Handle image upload
                if (teamFileInput.files[0]) {
                    // In a real implementation, upload to Firebase Storage
                    memberData.image = document.getElementById('teamPreviewImage').src;
                } else if (memberId) {
                    // Keep existing image
                    const teamMembers = await loadTeam();
                    const existingMember = teamMembers.find(m => m.id === memberId);
                    memberData.image = existingMember?.image || 'img/team/default.jpg';
                } else {
                    memberData.image = 'img/team/default.jpg';
                }
                
                if (memberId) {
                    await updateTeamMember(memberId, memberData);
                    showSuccessAlert('Membro del team aggiornato con successo!', teamSuccessAlert, teamSuccessMessage);
                } else {
                    await addTeamMember(memberData);
                    showSuccessAlert('Membro del team aggiunto con successo!', teamSuccessAlert, teamSuccessMessage);
                }
                
                await loadTeamData();
                teamModal.classList.remove('show');
                modalBackdrop.classList.remove('show');
                
            } catch (error) {
                console.error("Errore durante il salvataggio:", error);
                alert(`Errore durante il salvataggio: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salva';
            }
        });

        // Save team settings
        document.getElementById('saveTeamSettingsBtn').addEventListener('click', async function() {
            try {
                const settings = {
                    titolo: document.getElementById('teamTitolo').value,
                    introduzione: document.getElementById('teamIntro').value
                };
                
                await saveTeamSettings(settings);
                showSuccessAlert('Impostazioni team salvate con successo!', teamSuccessAlert, teamSuccessMessage);
            } catch (error) {
                console.error("Errore durante il salvataggio delle impostazioni:", error);
                alert(`Errore durante il salvataggio: ${error.message}`);
            }
        });

        // Chiudi i modal se si clicca fuori (solo su modalBackdrop)
        modalBackdrop.addEventListener('click', function() {
            pizzaModal.classList.remove('show');
            deleteModal.classList.remove('show');
            carouselModal.classList.remove('show');
            valoreModal.classList.remove('show');
            ingredienteModal.classList.remove('show');
            galleryModal.classList.remove('show');
            teamModal.classList.remove('show');
            modalBackdrop.classList.remove('show');
        });
        
    });
    </script>
</body>
</html>