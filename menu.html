<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√π Pizze - PIZZIAMO?! - La tua pizzeria di fiducia</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/menu.css">    <script type="module" src="js/firebase-config.js"></script>
</head>
<body>
    <!-- Header con Logo e Menu Principale -->
    <header>
        <div class="container header-container">
            <div class="logo-contact-container">
                <a href="index.html" class="logo">
                    <div id="logo-container">
                        <img src="img/logopizzeria.png" alt="PIZZIAMO Logo">
                    </div>
                </a>
                <div class="contact-info">
                    <div class="address">
                        <i class="icon">üìç</i>
                        <span>Via Pontegradella 289/A, 44123 Ferrara (FE)</span>
                    </div>
                    <div class="phone">
                        <i class="icon">üìû</i>
                        <span>Tel: 000000000</span>
                    </div>
                </div>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="chi-siamo.html"><i class="icon">üë•</i> Chi siamo</a></li>
                    <li><a href="menu.html" class="active"><i class="icon">üçï</i> Men√π</a></li>
                    <li><a href="#app"><i class="icon">üì±</i> Scarica App</a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- Page Hero -->
    <div class="page-hero">
        <div class="container page-hero-content">
            <h1>Il nostro Men√π</h1>
            <p>Scopri le nostre pizze realizzate con ingredienti freschi e di qualit√†</p>
            <div class="breadcrumb">
                <a href="index.html">Home</a>
                <span>‚Ä∫</span>
                <a href="menu.html">Men√π</a>
            </div>
        </div>
    </div>
    
    <!-- Menu Content -->
    <section class="section">
        <div class="container">
            <h2 class="section-title">Scegli la tua Pizza Preferita</h2>
            
            <!-- Menu Tabs -->
            <div class="menu-tabs">
                <button class="menu-tab active" data-category="all">Tutte le Pizze</button>
                <button class="menu-tab" data-category="classiche">Classiche</button>
                <button class="menu-tab" data-category="speciali">Specialit√†</button>
                <button class="menu-tab" data-category="limited">Limited Edition</button>
                <button class="menu-tab" data-category="vegane">Vegane</button>
                <button class="menu-tab" data-category="senza-glutine">Senza Glutine</button>
            </div>
            
            <!-- Filtro Extra -->
            <div class="menu-filter">
                <button class="filter-btn active" data-filter="all">Tutte</button>
                <button class="filter-btn" data-filter="new">Novit√†</button>
                <button class="filter-btn" data-filter="bestseller">Best Seller</button>
                <button class="filter-btn" data-filter="suggested">Consigliate</button>
            </div>
            
            <!-- Tutte le Pizze -->
            <div class="menu-category active" id="all">
                <div class="pizze-grid">
                    <!-- Pizza 1 - Margherita -->
                    <div class="pizza-card" data-category="classiche">
                        <div class="pizza-image-container">
                            <img src="img/pizza1.jpg" alt="Pizza Margherita" class="pizza-image">
                            <span class="pizza-badge">Classica</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Margherita</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">La classica pizza napoletana con pomodoro San Marzano DOP, mozzarella fiordilatte, basilico fresco e un filo d'olio extravergine d'oliva.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 7.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="1">Ordina</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pizza 2 - Diavola -->
                    <div class="pizza-card" data-category="classiche">
                        <div class="pizza-image-container">
                            <img src="img/pizza2.jpg" alt="Pizza Diavola" class="pizza-image">
                            <span class="pizza-badge">Classica</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Diavola</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Pomodoro San Marzano DOP, mozzarella fiordilatte e salame piccante. Per gli amanti del gusto deciso e leggermente piccante.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 8.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="2">Ordina</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pizza 3 - Carbonara Revolution -->
                    <div class="pizza-card" data-category="speciali">
                        <div class="pizza-image-container">
                            <img src="img/pizza3.jpg" alt="Carbonara Revolution" class="pizza-image">
                            <span class="pizza-badge">Specialit√†</span>
                            <div class="pizza-name-large">Carbonara Revolution</div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Con impasto Polesanissimo¬Æ, mozzarella, bacon, crema d'uovo, cipolla, scaglie di pecorino, pepe, olio EVO.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 12.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="3">Ordina</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pizza 4 - Parma in Puglia -->
                    <div class="pizza-card" data-category="limited">
                        <div class="pizza-image-container">
                            <img src="img/pizza4.jpg" alt="Parma in Puglia" class="pizza-image">
                            <span class="pizza-badge">Limited Edition</span>
                            <img src="https://firebasestorage.googleapis.com/v0/b/pizziamo-912b6.firebasestorage.app/o/badge%2Flimited-edition.png?alt=media" class="pizza-limited" alt="Limited Edition">
                            <div class="pizza-name-large">Parma in Puglia</div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Gli ingredienti pregiati sono confezionati a parte per garantire la miglior esperienza. Con impasto Polesanissimo¬Æ, pomodoro, mozzarella di bufala, crudo di Montagnana 24 mesi e burrata, basilico, olio Evo.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 14.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="4">Ordina</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pizza 5 - Veg Garden -->
                    <div class="pizza-card" data-category="vegane">
                        <div class="pizza-image-container">
                            <img src="img/pizza5.jpg" alt="Veg Garden" class="pizza-image">
                            <span class="pizza-badge">Vegana</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Veg Garden</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Pomodoro San Marzano DOP, formaggio vegetale, zucchine, melanzane, peperoni, pomodorini e basilico fresco.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 10.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="5">Ordina</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pizza 6 - Margherita Gluten Free -->
                    <div class="pizza-card" data-category="senza-glutine">
                        <div class="pizza-image-container">
                            <img src="img/pizza1.jpg" alt="Margherita Gluten Free" class="pizza-image">
                            <span class="pizza-badge">Senza Glutine</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Margherita Gluten Free</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">La classica pizza napoletana con pomodoro San Marzano DOP, mozzarella fiordilatte, basilico fresco e un filo d'olio extravergine d'oliva, su base senza glutine.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 9.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="6">Ordina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Classiche -->
            <div class="menu-category" id="classiche">
                <div class="category-description">
                    <p>Le nostre pizze classiche, realizzate secondo la tradizione italiana con ingredienti selezionati e di alta qualit√†.</p>
                </div>
                <div class="pizze-grid">
                    <!-- Pizza 1 - Margherita -->
                    <div class="pizza-card" data-category="classiche">
                        <div class="pizza-image-container">
                            <img src="img/pizza1.jpg" alt="Pizza Margherita" class="pizza-image">
                            <span class="pizza-badge">Classica</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Margherita</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">La classica pizza napoletana con pomodoro San Marzano DOP, mozzarella fiordilatte, basilico fresco e un filo d'olio extravergine d'oliva.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 7.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="1">Ordina</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pizza 2 - Diavola -->
                    <div class="pizza-card" data-category="classiche">
                        <div class="pizza-image-container">
                            <img src="img/pizza2.jpg" alt="Pizza Diavola" class="pizza-image">
                            <span class="pizza-badge">Classica</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Diavola</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Pomodoro San Marzano DOP, mozzarella fiordilatte e salame piccante. Per gli amanti del gusto deciso e leggermente piccante.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 8.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="2">Ordina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Specialit√† -->
            <div class="menu-category" id="speciali">
                <div class="category-description">
                    <p>Le nostre pizze speciali, creazioni uniche dello chef che combinano sapori tradizionali e innovativi.</p>
                </div>
                <div class="pizze-grid">
                    <!-- Pizza 3 - Carbonara Revolution -->
                    <div class="pizza-card" data-category="speciali">
                        <div class="pizza-image-container">
                            <img src="img/pizza3.jpg" alt="Carbonara Revolution" class="pizza-image">
                            <span class="pizza-badge">Specialit√†</span>
                            <div class="pizza-name-large">Carbonara Revolution</div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Con impasto Polesanissimo¬Æ, mozzarella, bacon, crema d'uovo, cipolla, scaglie di pecorino, pepe, olio EVO.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 12.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="3">Ordina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Limited Edition -->
            <div class="menu-category" id="limited">
                <div class="category-description">
                    <p>Le nostre pizze in edizione limitata, disponibili solo per un periodo di tempo. Ingredienti stagionali e di altissima qualit√†.</p>
                </div>
                <div class="pizze-grid">
                    <!-- Pizza 4 - Parma in Puglia -->
                    <div class="pizza-card" data-category="limited">
                        <div class="pizza-image-container">
                            <img src="img/pizza4.jpg" alt="Parma in Puglia" class="pizza-image">
                            <span class="pizza-badge">Limited Edition</span>
                            <img src="https://firebasestorage.googleapis.com/v0/b/pizziamo-912b6.firebasestorage.app/o/badge%2Flimited-edition.png?alt=media" class="pizza-limited" alt="Limited Edition">
                            <div class="pizza-name-large">Parma in Puglia</div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Gli ingredienti pregiati sono confezionati a parte per garantire la miglior esperienza. Con impasto Polesanissimo¬Æ, pomodoro, mozzarella di bufala, crudo di Montagnana 24 mesi e burrata, basilico, olio Evo.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 14.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="4">Ordina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Vegane -->
            <div class="menu-category" id="vegane">
                <div class="category-description">
                    <p>Le nostre pizze 100% vegetali, senza ingredienti di origine animale ma con tutto il gusto delle pizze tradizionali.</p>
                </div>
                <div class="pizze-grid">
                    <!-- Pizza 5 - Veg Garden -->
                    <div class="pizza-card" data-category="vegane">
                        <div class="pizza-image-container">
                            <img src="img/pizza5.jpg" alt="Veg Garden" class="pizza-image">
                            <span class="pizza-badge">Vegana</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Veg Garden</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">Pomodoro San Marzano DOP, formaggio vegetale, zucchine, melanzane, peperoni, pomodorini e basilico fresco.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 10.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="5">Ordina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Senza Glutine -->
            <div class="menu-category" id="senza-glutine">
                <div class="category-description">
                    <p>Le nostre pizze senza glutine, preparate in ambiente controllato con ingredienti certificati per chi soffre di intolleranze o celiachia.</p>
                </div>
                <div class="pizze-grid">
                    <!-- Pizza 6 - Margherita Gluten Free -->
                    <div class="pizza-card" data-category="senza-glutine">
                        <div class="pizza-image-container">
                            <img src="img/pizza1.jpg" alt="Margherita Gluten Free" class="pizza-image">
                            <span class="pizza-badge">Senza Glutine</span>
                            <div class="pizza-name-overlay">
                                <h3 class="pizza-title">Margherita Gluten Free</h3>
                            </div>
                        </div>
                        <div class="pizza-content">
                            <p class="pizza-description">La classica pizza napoletana con pomodoro San Marzano DOP, mozzarella fiordilatte, basilico fresco e un filo d'olio extravergine d'oliva, su base senza glutine.</p>
                            <div class="pizza-footer">
                                <div class="pizza-price">‚Ç¨ 9.50</div>
                                <button class="btn btn-primary order-btn" data-pizza-id="6">Ordina</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Modal per dettagli pizza -->
    <div class="modal" id="pizzaModal">
        <div class="modal-content">
            <button class="modal-close" id="closeModal">√ó</button>
            <div class="modal-pizza">
                <div class="modal-pizza-image" id="modalPizzaImage"></div>
                <div class="modal-pizza-info">
                    <h2 class="modal-pizza-title" id="modalPizzaTitle">Titolo Pizza</h2>
                    <span class="modal-pizza-badge" id="modalPizzaBadge">Categoria</span>
                    <p class="modal-pizza-description" id="modalPizzaDescription">Descrizione della pizza</p>
                    
                    <div class="modal-pizza-ingredients">
                        <h3>Ingredienti</h3>
                        <div class="ingredients-list" id="modalIngredientsList">
                            <!-- Gli ingredienti verranno inseriti dinamicamente -->
                        </div>
                    </div>
                    
                    <div class="modal-pizza-options">
                        <h3>Opzioni</h3>
                        <div class="options-list">
                            <div class="option-item active">Standard</div>
                            <div class="option-item">Doppia Mozzarella (+‚Ç¨1.50)</div>
                            <div class="option-item">Cornicione Ripieno (+‚Ç¨2.00)</div>
                        </div>
                    </div>
                    
                    <div class="modal-pizza-actions">
                        <div class="modal-pizza-price" id="modalPizzaPrice">‚Ç¨ 0.00</div>
                        <div class="quantity-selector">
                            <button class="quantity-btn" id="decreaseQty">-</button>
                            <input type="number" class="quantity-input" id="pizzaQuantity" value="1" min="1" max="10">
                            <button class="quantity-btn" id="increaseQty">+</button>
                        </div>
                        <button class="add-to-cart-btn" id="addToCartBtn">Aggiungi al carrello</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CTA Section -->
    <section class="cta-section">
        <div class="container">
            <div class="cta-content">
                <h2 class="cta-title">Vuoi un'esperienza ancora migliore?</h2>
                <p class="cta-text">Scarica la nostra app per ordinare in modo pi√π veloce, accumulare punti fedelt√† e ricevere offerte esclusive.</p>
                <div class="cta-buttons">
                    <a href="https://apps.apple.com/it/app/pizziamo/id1441122313" target="_blank" class="cta-btn cta-btn-primary">App Store</a>
                    <a href="https://play.google.com/store/apps/details?id=net.pizziamo.ordine" target="_blank" class="cta-btn cta-btn-secondary">Google Play</a>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h3>Contatti</h3>
                <ul>
                    <li>Via Pontegradella 289/A, 44123 Ferrara (FE)</li>
                    <li>Tel: 000000000</li>
                    <li>Email: info@pizziamo.it</li>
                    <li>Orari: 17:00-22:00</li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Link Utili</h3>
                <ul>
                    <li><a href="#">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            <p>&copy; 2025 PIZZIAMO?! Tutti i diritti riservati.</p>
        </div>
    </footer>
    
    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        let allPizzasData = []; // Store all fetched pizzas globally within the module

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Riferimento alla collezione pizze
                const pizzeCollection = collection(db, 'pizze');
                
                // Query per ottenere solo le pizze attive
                const pizzeQuery = query(
                    pizzeCollection, 
                    where('status', '==', 1)
                    // orderBy('name') // Firestore requires an index for this, or it can be done client-side
                );
                
                const querySnapshot = await getDocs(pizzeQuery);
                
                querySnapshot.forEach((doc) => {
                    allPizzasData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort pizzas by name client-side
                allPizzasData.sort((a, b) => a.name.localeCompare(b.name));
                
                // Popoliamo la griglia delle pizze
                populatePizzaGrid(allPizzasData);
                
                // Impostiamo i filtri e i tab
                setupMenuTabs(allPizzasData);
                setupFilterButtons(allPizzasData); // Pass allPizzasData to filter buttons setup
                
            } catch (error) {
                console.error("Errore durante il caricamento delle pizze:", error);
                // Mostra un messaggio utente-friendly
                const allPizzaGrid = document.querySelector('#all .pizze-grid');
                if (allPizzaGrid) {
                    allPizzaGrid.innerHTML = '<div style="text-align:center; width:100%; padding:20px;">'+
                                             '<p>Impossibile caricare il menu. Riprova pi√π tardi.</p>'+
                                             '</div>';
                }
            }

            // Modal handling (original logic, adapted)
            const modal = document.getElementById('pizzaModal');
            const closeModalBtn = document.getElementById('closeModal');

            // Chiudi il modal
            closeModalBtn.addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto'; // Ripristina lo scroll
            });

            // Chiudi il modal anche cliccando fuori
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });

            // Gestione quantit√†
            const decreaseBtn = document.getElementById('decreaseQty');
            const increaseBtn = document.getElementById('increaseQty');
            const quantityInput = document.getElementById('pizzaQuantity');

            decreaseBtn.addEventListener('click', function() {
                let qty = parseInt(quantityInput.value);
                if (qty > 1) {
                    quantityInput.value = qty - 1;
                }
            });

            increaseBtn.addEventListener('click', function() {
                let qty = parseInt(quantityInput.value);
                if (qty < 10) { // Max 10, can be adjusted
                    quantityInput.value = qty + 1;
                }
            });

            // Opzioni pizza
            const optionItems = document.querySelectorAll('.option-item');
            optionItems.forEach(item => {
                item.addEventListener('click', function() {
                    optionItems.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    // Future: Update price based on option
                });
            });

            // Aggiungi al carrello
            document.getElementById('addToCartBtn').addEventListener('click', function() {
                const pizzaTitle = document.getElementById('modalPizzaTitle').textContent;
                const quantity = document.getElementById('pizzaQuantity').value;
                // Future: Add selected options and actual pizza object to cart
                alert(`${quantity}x ${pizzaTitle} aggiunta al carrello!`);
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            });
        });

        function populatePizzaGrid(pizzeToDisplay, targetCategory = 'all') {
            const allPizzaGrid = document.querySelector('#all .pizze-grid');
            const classichePizzaGrid = document.querySelector('#classiche .pizze-grid');
            const specialiPizzaGrid = document.querySelector('#speciali .pizze-grid');
            const limitedPizzaGrid = document.querySelector('#limited .pizze-grid');
            const veganePizzaGrid = document.querySelector('#vegane .pizze-grid');
            const senzaGlutinePizzaGrid = document.querySelector('#senza-glutine .pizze-grid');

            // Clear all grids initially if it's the first population or a full refresh
            if (targetCategory === 'all' && pizzeToDisplay === allPizzasData) {
                 [allPizzaGrid, classichePizzaGrid, specialiPizzaGrid, limitedPizzaGrid, veganePizzaGrid, senzaGlutinePizzaGrid].forEach(grid => {
                    if(grid) grid.innerHTML = '';
                 });
            } else if (targetCategory !== 'all') {
                // Clear only the specific category grid if filtering within a category view
                const categoryGrid = document.querySelector(`#${targetCategory} .pizze-grid`);
                if (categoryGrid) categoryGrid.innerHTML = '';
            }


            pizzeToDisplay.forEach(pizza => {
                const pizzaCard = createPizzaCard(pizza);
                
                // Add to "Tutte le Pizze" grid if it's the 'all' category view or initial load
                if (allPizzaGrid && (targetCategory === 'all' || pizzeToDisplay === allPizzasData)) {
                     allPizzaGrid.appendChild(pizzaCard.cloneNode(true));
                }

                // Add to specific category grids if it's the initial load
                 if (pizzeToDisplay === allPizzasData) {
                    switch (pizza.category) {
                        case 'classiche':
                            if(classichePizzaGrid) classichePizzaGrid.appendChild(pizzaCard.cloneNode(true));
                            break;
                        case 'speciali':
                            if(specialiPizzaGrid) specialiPizzaGrid.appendChild(pizzaCard.cloneNode(true));
                            break;
                        case 'limited':
                            if(limitedPizzaGrid) limitedPizzaGrid.appendChild(pizzaCard.cloneNode(true));
                            break;
                        case 'vegane':
                            if(veganePizzaGrid) veganePizzaGrid.appendChild(pizzaCard.cloneNode(true));
                            break;
                        case 'senza-glutine':
                            if(senzaGlutinePizzaGrid) senzaGlutinePizzaGrid.appendChild(pizzaCard.cloneNode(true));
                            break;
                    }
                } else if (targetCategory !== 'all') {
                    // If filtering within a specific category view, only populate that category's grid
                    const currentCategoryGrid = document.querySelector(`#${targetCategory} .pizze-grid`);
                    if (currentCategoryGrid && pizza.category === targetCategory) {
                        currentCategoryGrid.appendChild(pizzaCard.cloneNode(true));
                    }
                }
            });
            
            setupOrderButtons(pizzeToDisplay); // Pass the currently displayed pizzas
        }

        function createPizzaCard(pizza) {
            const div = document.createElement('div');
            div.className = 'pizza-card';
            div.setAttribute('data-category', pizza.category);
            div.setAttribute('data-id', pizza.id); // Use Firestore ID
            if (pizza.isNew) div.setAttribute('data-new', 'true');
            if (pizza.isBestseller) div.setAttribute('data-bestseller', 'true');
            if (pizza.isSuggested) div.setAttribute('data-suggested', 'true');
            
            let cardContent = `
                <div class="pizza-image-container">
                    <img src="${pizza.image || 'img/default-pizza.png'}" alt="${pizza.name}" class="pizza-image">
                    <span class="pizza-badge">${pizza.badge || pizza.category}</span>`;
            
            if (pizza.isLimited) {
                 cardContent += `<img src="https://firebasestorage.googleapis.com/v0/b/pizziamo-912b6.firebasestorage.app/o/badge%2Flimited-edition.png?alt=media" class="pizza-limited" alt="Limited Edition">`;
            }
            if (pizza.largeTitle) {
                cardContent += `<div class="pizza-name-large">${pizza.name}</div>`;
            } else {
                cardContent += `
                    <div class="pizza-name-overlay">
                        <h3 class="pizza-title">${pizza.name}</h3>
                    </div>`;
            }
            
            cardContent += `
                </div>
                <div class="pizza-content">
                    <p class="pizza-description">${pizza.description}</p>
                    <div class="pizza-footer">
                        <div class="pizza-price">‚Ç¨ ${parseFloat(pizza.price).toFixed(2)}</div>
                        <button class="btn btn-primary order-btn" data-pizza-id="${pizza.id}">Ordina</button>
                    </div>
                </div>`;
            
            div.innerHTML = cardContent;
            return div;
        }

        function setupOrderButtons(pizzasForModal) {
            document.querySelectorAll('.order-btn').forEach(btn => {
                // Remove existing event listeners to prevent multiple triggers
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', function() {
                    const pizzaId = this.getAttribute('data-pizza-id');
                    openPizzaModal(pizzaId, pizzasForModal);
                });
            });
        }

        function setupMenuTabs(pizzas) {
            const menuTabs = document.querySelectorAll('.menu-tab');
            const menuCategories = document.querySelectorAll('.menu-category');
            
            menuTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    
                    menuTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    menuCategories.forEach(cat => cat.classList.remove('active'));
                    
                    const activeCategoryElement = document.getElementById(category);
                    if (activeCategoryElement) {
                        activeCategoryElement.classList.add('active');
                    }

                    // Reset sub-filters to "Tutte"
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');

                    // Repopulate grid for the selected category
                    if (category === 'all') {
                        populatePizzaGrid(pizzas, 'all');
                    } else {
                        const filteredPizzas = pizzas.filter(p => p.category === category);
                        populatePizzaGrid(filteredPizzas, category);
                    }
                });
            });
        }

        function setupFilterButtons(pizzas) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const activeMenuTab = document.querySelector('.menu-tab.active');
                    const currentCategory = activeMenuTab ? activeMenuTab.getAttribute('data-category') : 'all';

                    let pizzasToFilter = pizzas; // Start with all pizzas (or allPizzasData if pizzas is a subset)
                                        // If we are in a specific category tab, filter from allPizzasData based on that category first
                    if (currentCategory !== 'all') {
                        pizzasToFilter = allPizzasData.filter(p => p.category === currentCategory);
                    } else {
                        pizzasToFilter = allPizzasData; // Ensure we are filtering from the complete list for 'all' tab
                    }


                    let filteredPizzas = pizzasToFilter;
                    if (filterType === 'new') {
                        filteredPizzas = pizzasToFilter.filter(p => p.isNew);
                    } else if (filterType === 'bestseller') {
                        filteredPizzas = pizzasToFilter.filter(p => p.isBestseller);
                    } else if (filterType === 'suggested') {
                        filteredPizzas = pizzasToFilter.filter(p => p.isSuggested);
                    }
                    // 'all' filterType means show all from pizzasToFilter

                    // Determine which grid to populate
                    const targetGridCategory = currentCategory === 'all' ? 'all' : currentCategory;
                    const gridToPopulate = document.querySelector(`#${targetGridCategory} .pizze-grid`);
                    
                    if (gridToPopulate) {
                        gridToPopulate.innerHTML = ''; // Clear current grid
                        filteredPizzas.forEach(pizza => {
                            gridToPopulate.appendChild(createPizzaCard(pizza));
                        });
                        setupOrderButtons(filteredPizzas); // Re-attach order buttons for new cards
                    } else if (currentCategory === 'all') { // Special case for "Tutte le Pizze" main grid
                        const allGrid = document.querySelector('#all .pizze-grid');
                        if(allGrid) {
                            allGrid.innerHTML = '';
                             filteredPizzas.forEach(pizza => {
                                allGrid.appendChild(createPizzaCard(pizza));
                            });
                            setupOrderButtons(filteredPizzas);
                        }
                    }
                });
            });
        }

        function openPizzaModal(pizzaId, currentPizzaList) {
            const pizza = (currentPizzaList || allPizzasData).find(p => p.id === pizzaId); // Search in current list or fallback to all
            
            if (pizza) {
                document.getElementById('modalPizzaTitle').textContent = pizza.name;
                document.getElementById('modalPizzaBadge').textContent = pizza.badge || pizza.category;
                document.getElementById('modalPizzaDescription').textContent = pizza.description;
                document.getElementById('modalPizzaPrice').textContent = `‚Ç¨ ${parseFloat(pizza.price).toFixed(2)}`;
                document.getElementById('modalPizzaImage').style.backgroundImage = `url('${pizza.image || 'img/default-pizza.png'}')`;
                
                const ingredientsList = document.getElementById('modalIngredientsList');
                ingredientsList.innerHTML = ''; // Clear previous ingredients
                if (pizza.ingredients && Array.isArray(pizza.ingredients)) {
                    pizza.ingredients.forEach(ingredient => {
                        const ingItem = document.createElement('div');
                        ingItem.className = 'ingredient-item';
                        ingItem.textContent = ingredient;
                        ingredientsList.appendChild(ingItem);
                    });
                } else {
                    ingredientsList.innerHTML = '<div class="ingredient-item">Ingredienti non specificati.</div>';
                }
                
                document.getElementById('pizzaModal').classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                console.error("Pizza non trovata per il modal:", pizzaId);
                alert("Dettagli pizza non disponibili.");
            }
        }
    </script>
</body>
</html>